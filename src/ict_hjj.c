#define  PAS_SRCFILE      3333#include <stdio.h>#include <stdlib.h>#include <string.h>#include <sys/stat.h>#include <string.h>#include <locale.h>#include <unistd.h>#include <sys/types.h>#include <sys/socket.h>#include <netinet/in.h>#include <arpa/inet.h>#include <netdb.h>#include <sys/time.h>#include "utoall.h"#include "utoplt01.h"#include "pasdb.h"#include "ncportal.h"#include <iconv.h>#include "ict_hjj_tool.h"#define SERVICE_INFO 1//用户登录的邋FunName在Ict_wp.c中实现，ict_login不再使用int ict_login(utShmHead *psShmHead, int iFd, utMsgHead *psMsgHead){    //sql语句处理有三种，查询的话用pasDbOneRecord    //pasDbOneRecord(sqlbuf, 0, UT_TYPE_LONG, 4, &lCount);一般是只返回一个数据，将数据存在lCount中    //insert,delete,update等用pasDbExecSqlF?    //查询语句用 psCur = pasDbOpenSql(sql, 0);    int iReturn = 0;    utMsgPrintMsg(psMsgHead);    char caVname[32] = "";    char caDname[24] = "";    char caPasswd[24] = "";    char caAddress[128] = "";    char caMname[24] = ""; //姓名    char caPackage[32] = "";    char sqlbuf[1024] = "";    ulong lCount = 0;    char caMsg[256] = "";    int caMoney = 0;    iReturn = utMsgGetSomeNVar(psMsgHead, 5,                               "vname",   UT_TYPE_STRING, sizeof(caVname) - 1, caVname,                               "dname",   UT_TYPE_STRING, sizeof(caDname) - 1, caDname,                               "passwd",  UT_TYPE_STRING, sizeof(caPasswd) - 1, caPasswd,                               "address",   UT_TYPE_STRING, sizeof(caAddress) - 1, caAddress,                               "mname",   UT_TYPE_STRING, sizeof(caMname) - 1, caMname);    utStrDelSpaces(caAddress);    utStrDelSpaces(caVname);    utPltDbHead *psDbHead = utPltInitDbHead();    if(strlen(caVname) > 0)    {        char sql[1024] = "";        pasDbCursor *psCur = NULL;        utPltDbHead *psDbHead = utPltInitDb();        int db_count = 0;        snprintf(sql, sizeof(sql), "select vname,mname,package,money from userlib where vname='%s' and passwd='%s'", caVname, caPasswd);        iReturn = pasDbOneRecord(sql, 0, UT_TYPE_STRING, sizeof(caVname) - 1, caVname,                                 UT_TYPE_STRING, sizeof(caMname) - 1, caMname,                                 UT_TYPE_STRING, sizeof(caPackage) - 1, caPackage,                                 UT_TYPE_LONG, 4, &caMoney);        printf("sql=%s, iReturn=%d\n", sql, iReturn);        if((iReturn == 0) || (1405 == iReturn))        {            snprintf(caMsg, sizeof(caMsg) - 1, "success", caVname);            utPltPutVar(psDbHead, "mesg", caMsg);            utPltPutVarF(psDbHead, "result", "%d", 0);            utPltPutVar(psDbHead, "vname", caVname);            utPltPutVar(psDbHead, "mname", caMname);            utPltPutVar(psDbHead, "package", caPackage);            utPltPutVarF(psDbHead, "money", "%d", caMoney);        }        else        {            snprintf(caMsg, sizeof(caMsg) - 1, "fail", caVname);            utPltPutVar(psDbHead, "mesg", caMsg);            utPltPutVarF(psDbHead, "result", "%d", 1);            utPltPutVar(psDbHead, "vname", caVname);            utPltPutVar(psDbHead, "mname", caMname);            utPltPutVar(psDbHead, "package", caPackage);            utPltPutVarF(psDbHead, "money", "%d", caMoney);        }        utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/login/login.htm");    }    return 0;}//显示可更改的套餐int ict_show_package(utShmHead * psShmHead, int iFd, utMsgHead * psMsgHead){#if SERVICE_INFO    utMsgPrintMsg(psMsgHead);#endif    uint8 caPackageid = 0;    char caName[32] = "";    char caNamedes[128] = "";    char caTsid[24] = {0};    uint4 caPtype = 0;    uint4 caMoney = 0;    char start_in[8] = "";    char limit_in[8] = "";    //取前台的参数来赋值给变量，可以用来作为数据库查询条件，前台向后台专递数据的方式一般为querystring的方式，如果有传参数的话，就将参数付给相应的值    utMsgGetSomeNVar(psMsgHead, 8,                     "packageid", UT_TYPE_LONG8, sizeof(caPackageid), &caPackageid,                     "name", UT_TYPE_STRING,  sizeof(caName) - 1,  caName,                     "namedes",  UT_TYPE_STRING,  sizeof(caNamedes) - 1,   caNamedes,                     "ptype",    UT_TYPE_ULONG,  sizeof(caPtype),    &caPtype,                     "money",    UT_TYPE_ULONG,  sizeof(caMoney),    &caMoney,                     "start",    UT_TYPE_STRING,  sizeof(start_in) - 1,    start_in,                     "limit",     UT_TYPE_STRING,      sizeof(limit_in) - 1,    limit_in,                     "tsid",      UT_TYPE_STRING,      sizeof(caTsid) - 1,      caTsid);    char sql[1024] = "";    pasDbCursor *psCur = NULL;    utPltDbHead *psDbHead = utPltInitDb();    if(checkTsid(psShmHead, psDbHead, psMsgHead, iFd, caTsid, "school/package/update_package.htm"))    {        return 0;    }    int db_count = 0;    snprintf(sql, sizeof(sql), "select count(*) from package");    pasLogs(PAS_SRCFILE, 1000, "sqlbuf=%s  \n", sql);    psCur = pasDbOpenSql(sql, 0);    pasDbFetchInto(psCur, UT_TYPE_ULONG, 4, &db_count);    pasDbCloseCursor(psCur);    utPltPutVarF(psDbHead, "TotRec", "%lu", db_count);    snprintf(sql, sizeof(sql), "select id,name,namedes,ptype,money from package where 1=1 limit %u,%u", atoi(start_in), atoi(limit_in));    printf("sqlbuf=%s  \n", sql);#if SERVICE_INFO    printf("%s\n", sql);#endif    psCur = pasDbOpenSql(sql, 0);    if(psCur != NULL)    {        uint8 packageid = 0;        char name[32] = "";        char namedes[128] = "";        uint4 ptype = 0;        uint4 money = 0;        int iret = -1;        int iNum = 0;        while(0 == (iret = pasDbFetchInto(psCur,                                          UT_TYPE_ULONG, 8, &packageid,                                          UT_TYPE_STRING, sizeof(name) - 1, name,                                          UT_TYPE_STRING, sizeof(namedes) - 1, namedes,                                          UT_TYPE_ULONG, 4, &ptype,                                          UT_TYPE_ULONG, 4, &money)) || 1405 == iret)        {            iNum++;            if(iNum > 1)            {                utPltPutLoopVar(psDbHead, "dh", iNum, ",");            }            utPltPutLoopVarF(psDbHead, "id", iNum, "%d", packageid);            utPltPutLoopVar(psDbHead, "name", iNum, convert("GBK", "UTF-8", name));            utPltPutLoopVar(psDbHead, "namedes", iNum, convert("GBK", "UTF-8", namedes));            utPltPutLoopVarF(psDbHead, "ptype", iNum, "%d", ptype);            utPltPutLoopVarF(psDbHead, "money", iNum, "%d", money);            printf("name=%s\n", name);        }        pasDbCloseCursor(psCur);    }#if SERVICE_INFO    //utPltShowDb(psDbHead);#endif    utPltPutVarF(psDbHead, "result", "%d", 0);    utPltPutVarF(psDbHead, "tsid", caTsid);    utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/package/update_package.htm");    return 0;}//客服与帮助int ict_support_help(utShmHead * psShmHead, int iFd, utMsgHead * psMsgHead){    utMsgPrintMsg(psMsgHead);    int id = 0;    char messageTitle[256] = "";    char messageContent[256] = "";    int iReturn = 0;    char caMsg[256] = "";    char caTsid[24] = {0};    //取前台的参数来赋值给变量，可以用来作为数据库查询条件，前台向后台专递数据的方式一般为querystring的方式，如果有传参数的话，就将参数付给相应的值    //这个地方的数字必须和底下的参数的个数相同    utMsgGetSomeNVar(psMsgHead, 4,                     "id", UT_TYPE_LONG8, sizeof(id), &id,                     "messageTitle", UT_TYPE_STRING, sizeof(messageTitle) - 1, messageTitle,                     "messageContent", UT_TYPE_STRING, sizeof(messageContent) - 1, messageContent,                     "tsid", UT_TYPE_STRING, sizeof(caTsid) - 1, caTsid                    );    char sql[1024] = "";    pasDbCursor *psCur = NULL;    utPltDbHead *psDbHead = utPltInitDb();    if(checkTsid(psShmHead, psDbHead, psMsgHead, iFd, caTsid, "school/support/support_help.htm"))    {        return 0;    }    //在使用sql之前，将sql的清空    memset(sql, 0, sizeof(sql));    snprintf(sql, sizeof(sql), "insert into help (messageTitle,messageContent)values('%s','%s')", convert("UTF-8", "GBK", messageTitle), convert("UTF-8", "GBK", messageContent));    printf("%s\n", sql);    iReturn = pasDbExecSql(sql, 0);    memset(caMsg, 0, sizeof(caMsg));    if(iReturn != 0)    {        utPltPutVarF(psDbHead, "result", "%d", 3);//添加留言失败!        utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/support/support_help.htm");    }    else    {        snprintf(caMsg, sizeof(caMsg) - 1, "添加留言成功!");        utPltPutVarF(psDbHead, "result", "%d", 0);//添加留言成功        utPltPutVarF(psDbHead, "tsid", caTsid);        utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/support/support_help.htm");    }    return  0;}//修改密码int ict_system_update_password(utShmHead *psShmHead, int iFd, utMsgHead *psMsgHead){    utMsgPrintMsg(psMsgHead);    char vName[32] = "";//用户名,对应ncsrvuser表中的username    char oldPasswd[32] = "";//原来的密码    char newPasswd[32] = "";//新密码    ulong lCount = 0;    char caMsg[256] = "";    char caTsid[24] = {0};    int iReturn = 0;    //取前台的参数来赋值给变量，可以用来作为数据库操作的依据，前台向后台专递数据的方式一般为querystring的方式，如果有传参数的话，就将参数付给相应的值    //这个地方的数字必须和底下的参数的个数相同    utMsgGetSomeNVar(psMsgHead, 3,                     "oldPasswd", UT_TYPE_STRING, sizeof(oldPasswd) - 1, oldPasswd,                     "newPasswd", UT_TYPE_STRING, sizeof(newPasswd) - 1, newPasswd,                     "tsid", UT_TYPE_STRING, sizeof(caTsid) - 1, caTsid                    );    char sqlbuf[1024] = "";    utPltDbHead *psDbHead = utPltInitDbHead();    if(checkTsid(psShmHead, psDbHead, psMsgHead, iFd, caTsid, "school/update_password/update_password.htm"))    {        return 0;    }    strcpy(vName, getVnameByTsId(psShmHead, atoll(caTsid)));    memset(sqlbuf, 0, sizeof(sqlbuf));    //首先验证下用户输入的旧密码是否正确，如果正确就执行下面的修改密码操作，如果不正确的话，那么直接将提示信息返回给前台    snprintf(sqlbuf, sizeof(sqlbuf) - 1, "select count(*) from ncsrvuser where username='%s' and password='%s'", vName, oldPasswd);    printf("sqlbuf=%s  \n", sqlbuf);    pasDbOneRecord(sqlbuf, 0, UT_TYPE_LONG, 4, &lCount);    if(lCount == 0)    {        snprintf(caMsg, sizeof(caMsg) - 1, "旧密码不正确");        utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));        utPltPutVarF(psDbHead, "result", "%d", 3);//旧密码不正确        utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/update_password/update_password.htm");        return 0;    }    //在使用sql之前，将sql的清空    memset(sqlbuf, 0, sizeof(sqlbuf));    snprintf(sqlbuf, sizeof(sqlbuf), "update ncsrvuser set password = '%s' where username ='%s'", newPasswd, vName);    printf("%s\n", sqlbuf);    iReturn = pasDbExecSql(sqlbuf, 0);    memset(caMsg, 0, sizeof(caMsg));    if(iReturn != 0)    {        snprintf(caMsg, sizeof(caMsg) - 1, "密码修改失败,sql语句执行不成功");        utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));        utPltPutVarF(psDbHead, "result", "%d", 4);//"密码修改失败,sql语句执行不成功        utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/update_password/update_password.htm");    }    else    {        snprintf(caMsg, sizeof(caMsg) - 1, "密码修改成功");        utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));        utPltPutVarF(psDbHead, "result", "%d", 0);//密码修改成功        utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/update_password/update_password.htm");    }    return  0;}//更改套餐操作int ict_change_package(utShmHead *psShmHead, int iFd, utMsgHead *psMsgHead){    utMsgPrintMsg(psMsgHead);    char vName[32] = "";    //uint8 packageid = 0;    //uint8 timeval = 0;    char caTimeval[25] = {0};    char caPackageid[25] = {0};    ulong lCount = 0;    char caMsg[256] = "";    char caTsid[24] = {0};    int iReturn = 0;    //取前台的参数来赋值给变量，可以用来作为数据库操作的依据，前台向后台专递数据的方式一般为querystring的方式，如果有传参数的话，就将参数付给相应的值    //这个地方的数字必须和底下的参数的个数相同    utMsgGetSomeNVar(psMsgHead, 3,                     "packageid", UT_TYPE_STRING, sizeof(caPackageid) - 1, caPackageid,                     "timeval", UT_TYPE_STRING, sizeof(caTimeval) - 1, caTimeval,                     "tsid", UT_TYPE_STRING,  sizeof(caTsid) - 1, caTsid);    char sqlbuf[1024] = "";    sprintf(caTimeval, "%lu", time(0));    utPltDbHead *psDbHead = utPltInitDbHead();    if(checkTsid(psShmHead, psDbHead, psMsgHead, iFd, caTsid, "school/package/change_package.htm"))    {        return 0;    }    strcpy(vName, getVnameByTsId(psShmHead, atoll(caTsid)));    memset(sqlbuf, 0, sizeof(sqlbuf));    snprintf(sqlbuf, sizeof(sqlbuf), "update userlib set packageid =%llu,timeval=%llu where vname ='%s'", strtoull(caPackageid, 0, 10), strtoull(caTimeval, 0, 10), vName);    printf("%s\n", sqlbuf);    iReturn = pasDbExecSql(sqlbuf, 0);    memset(caMsg, 0, sizeof(caMsg));    if(iReturn != 0)    {        snprintf(caMsg, sizeof(caMsg) - 1, "套餐修改失败!,sql语句执行不成功!");        utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));        utPltPutVarF(psDbHead, "result", "%d", 3);//套餐修改失败        utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/package/change_package.htm");    }    else    {        snprintf(caMsg, sizeof(caMsg) - 1, "套餐修改成功!");        utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));        utPltPutVarF(psDbHead, "result", "%d", 0);//套餐修改成功        utPltPutVarF(psDbHead, "tsid", caTsid);        utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/package/change_package.htm");    }    return  0;}//手机端更改套餐操作int ict_change_package_mobile(utShmHead *psShmHead, int iFd, utMsgHead *psMsgHead){    //首先判断余额是否充足，如果充足的话，再进行下面的操作，如果不足的话，直接退出，提示前台    //判断从前台获取的生效类型，判断是立即生效，还是原套餐结束后生效    //如果是立即生效，直接将目前生效的套餐的状态设置为失效，然后添加一条新的套餐信息，并设置生效和失效时间，以及写入日志    //如果是原套餐结束后生效的话，那么目前的套餐状态不改动，添加一天新的套餐，而且都是先扣钱后再添加日志和    //根据用户名在用户订购套餐表查询    utMsgPrintMsg(psMsgHead);//在终端打印出信息    char caVname[32] = {0};//虚拟身份号    uint8 u8TimeVal = 0;//套餐生效日期    char caTimeVal[16] = {0};//套餐生效日期(临时参数)    uint4 u4PackageId = 0;//新的套餐id    char caPackageId[16] = {0};//新的套餐id(临时参数)    uint4 u4UserPackageId = 0;//旧的套餐id(userpackage的id)    char caUserPackageId[16] = {0};//旧的套餐id(userpackage的id,临时参数)    char caStatus[2] = {0};//userpackage的状态    //要通过sql语句获取的变量    uint4 u4PackageMoney = 0;//套餐金额    uint4 u4Pdays = 0;//套餐天数    uint4 u4AccountMoney = 0;//账户余额    //通过计算获得的变量    uint8 u8EndTime = 0;//套餐结束时间    int iDstatus = 1;//订购状态，更改套餐的订购状态为已支付    uint8 u8Dtime = time(0);//订购时间为当前系统时间    ulong lCount = 0;    char caMsg[256] = {0};    char caTsid[24] = {0};    int iReturn = 0;    //取前台的参数来赋值给变量，可以用来作为数据库操作的依据，前台向后台专递数据的方式一般为querystring的方式，如果有传参数的话，就将参数付给相应的值    //这个地方的数字必须和底下的参数的个数相同    utMsgGetSomeNVar(psMsgHead, 5,                     "packageid", UT_TYPE_STRING, 15, caPackageId,                     "oldPackageid", UT_TYPE_STRING, 15, caUserPackageId,                     "status", UT_TYPE_STRING, sizeof(caStatus) - 1, caStatus,                     "timeval", UT_TYPE_STRING, 15, caTimeVal,                     "tsid", UT_TYPE_STRING,  sizeof(caTsid) - 1, caTsid);    char sqlbuf[1024] = "";    utPltDbHead *psDbHead = utPltInitDbHead();    if(checkTsid(psShmHead, psDbHead, psMsgHead, iFd, caTsid, "school/package/change_package.htm"))    {        return 0;    }    //将临时变量赋值到真实变量    u8TimeVal = strtoull(caTimeVal , 0 , 10);    u4PackageId = strtoul(caPackageId , 0 , 10);    u4UserPackageId = strtoul(caUserPackageId , 0 , 10);    //通过tsid找到对应的vName    strcpy(caVname, getVnameByTsId(psShmHead, atoll(caTsid)));    //第一步:通过vName来在package数据库中获取套餐金额和套餐天数    memset(sqlbuf, 0, sizeof(sqlbuf));    snprintf(sqlbuf, sizeof(sqlbuf), "select money,pdays from package where id=%u", u4PackageId);    iReturn = pasDbOneRecord(sqlbuf, 0, UT_TYPE_LONG, 4, &u4PackageMoney,                             UT_TYPE_LONG, 4, &u4Pdays);    printf("sqlbuf=%s, iReturn=%d\n", sqlbuf, iReturn);    //sql语句执行成功    if((iReturn == 0) || (1405 == iReturn))    {        //查询套餐金额和套餐天数天数成功    }    else    {        snprintf(caMsg, sizeof(caMsg) - 1, "查询套餐金额和套餐天数失败!,sql语句执行不成功!");        utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));        utPltPutVarF(psDbHead, "result", "%d", 3);        utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/package/change_package.htm");        return 1;    }    //根据需要更换套餐的金额来将用户的余额扣除    //第二步，通过sql语句在userlib表中获取用户余额    memset(sqlbuf, 0, sizeof(sqlbuf));    snprintf(sqlbuf, sizeof(sqlbuf), "select money from userlib where vname='%s'", caVname);    iReturn = pasDbOneRecord(sqlbuf, 0, UT_TYPE_LONG, 4, &u4AccountMoney);    printf("sqlbuf=%s, iReturn=%d\n", sqlbuf, iReturn);    //sql语句执行成功    if((iReturn == 0) || (1405 == iReturn))    {        //查询余额成功    }    else    {        snprintf(caMsg, sizeof(caMsg) - 1, "查询余额失败!,sql语句执行不成功!");        utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));        utPltPutVarF(psDbHead, "result", "%d", 4);        utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/package/change_package.htm");        return 1;    }    //第三步,比较用户余额和套餐金额，如果用户余额大于套餐金额，则扣除套餐费用，更新userlib表。否则提示余额不足    if(u4AccountMoney >= u4PackageMoney)    {        //可以扣款        memset(sqlbuf, 0, sizeof(sqlbuf));        snprintf(sqlbuf, sizeof(sqlbuf), "update userlib set money=%u where vname ='%s'", (u4AccountMoney - u4PackageMoney), caVname);        printf("%s\n", sqlbuf);        iReturn = pasDbExecSql(sqlbuf, 0);        memset(caMsg, 0, sizeof(caMsg));        if(iReturn != 0)        {            snprintf(caMsg, sizeof(caMsg) - 1, "用户余额修改失败!,sql语句执行不成功!");            utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));            utPltPutVarF(psDbHead, "result", "%d", 5);//用户余额修改失败            utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/package/change_package.htm");            return 1;        }        else        {            //用户余额修改成功!        }    }    else    {        //余额不够，更换套餐失败        snprintf(caMsg, sizeof(caMsg) - 1, "套餐更换失败!,账户余额不足!");        utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));        utPltPutVarF(psDbHead, "result", "%d", 6);        utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/package/change_package.htm");        return 1;    }    //第四步，将套餐更改信息更新到userpackage中    //首先根据套餐开始日期和套餐天数计算套餐结束时间    u8EndTime = u8TimeVal + (u4Pdays * 24 * 60 * 60);    memset(sqlbuf, 0, sizeof(sqlbuf));    snprintf(sqlbuf, sizeof(sqlbuf), "update userpackage set  packageid=%u,starttime=%llu,endtime=%llu,status='%s' where id =%u", u4PackageId, u8TimeVal, u8EndTime, caStatus, u4UserPackageId);    printf("%s\n", sqlbuf);    iReturn = pasDbExecSql(sqlbuf, 0);    memset(caMsg, 0, sizeof(caMsg));    if(iReturn != 0)    {        snprintf(caMsg, sizeof(caMsg) - 1, "userpackage修改失败!,sql语句执行不成功!");        utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));        utPltPutVarF(psDbHead, "result", "%d", 7);        utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/package/change_package.htm");        return 1;    }    else    {        //userpackage修改成功    }    //第五步,在订单日志库中，添加订单日志    memset(sqlbuf, 0, sizeof(sqlbuf));    snprintf(sqlbuf, sizeof(sqlbuf), "insert into orderlog (vname,packageid,dstatus,dtime)values('%s',%u,%d,%llu)", caVname, u4PackageId, iDstatus, u8Dtime);    printf("%s\n", sqlbuf);    iReturn = pasDbExecSql(sqlbuf, 0);    memset(caMsg, 0, sizeof(caMsg));    if(iReturn != 0)    {        snprintf(caMsg, sizeof(caMsg) - 1, "添加订单日志失败!,sql语句执行不成功!");        utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));        utPltPutVarF(psDbHead, "result", "%d", 8);        utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/package/change_package.htm");        return 1;    }    else    {        snprintf(caMsg, sizeof(caMsg) - 1, "套餐修改成功!账户余额扣除%u元，账户余额:%u元", u4PackageMoney, (u4AccountMoney - u4PackageMoney));        utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));        utPltPutVarF(psDbHead, "result", "%d", 0);        utPltPutVarF(psDbHead, "tsid", caTsid);        utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/package/change_package.htm");    }    return  0;}//获取所有套餐信息int ict_getAllPackage(utShmHead *psShmHead, int iFd, utMsgHead *psMsgHead){    utMsgPrintMsg(psMsgHead);    uint4 u4Packageid = 0;//套餐id    char caNamech[31] = "";//套餐名称    char caNamedes[127] = "";//套餐说明    char caPicture[127] = "";//套餐图片    char caColorPicture[127] = "";//套餐色块    ulong u4Ptype = 0;//套餐类型    ulong u4Money = 0;//套餐金额    int iPdays = 0;//套餐天数    uint8 u8Begtime = 0;//套餐有效期起始时间    uint8 u8Endtime = 0;//套餐有效期结束时间    char caBegtime[32] = {0};//套餐有效期开始时间(时间格式:%Y-%m-%d)    char caEndtime[32] = {0};//套餐有效期结束时间(时间格式:%Y-%m-%d)    uint8 u8Timeval = 0;//编辑时间    char caCuser [31] = "";//编辑用户    char caContent[127] = "";//备注    int iret = -1;    int iNum = 0;    char caTsid[24] = {0};    char caMsg[256] = {0};    utMsgGetSomeNVar(psMsgHead, 1,                     "tsid",     UT_TYPE_STRING,      sizeof(caTsid) - 1,    caTsid);    char sql[1024] = "";    pasDbCursor *psCur = NULL;    utPltDbHead *psDbHead = utPltInitDb();    /*  if(checkTsid(psShmHead, psDbHead, psMsgHead, iFd, caTsid, "school/package/all_package.htm"))     {         return 0;     } */    int db_count = 0;    snprintf(sql, sizeof(sql) - 1, "select id,namech,namedes,ptype,pdays,money,picture,colorpicture,begtime,endtime,timeval,cuser,content from package");    psCur = pasDbOpenSql(sql, 0);    if(psCur != NULL)    {        while(0 == (iret = pasDbFetchInto(psCur,                                          UT_TYPE_ULONG, 4, &u4Packageid,                                          UT_TYPE_STRING, sizeof(caNamech) - 1, caNamech,                                          UT_TYPE_STRING, sizeof(caNamedes) - 1, caNamedes,                                          UT_TYPE_ULONG, 4, &u4Ptype,                                          UT_TYPE_ULONG, 4, &iPdays,                                          UT_TYPE_ULONG, 4, &u4Money,                                          UT_TYPE_STRING, sizeof(caPicture) - 1, caPicture,                                          UT_TYPE_STRING, sizeof(caColorPicture) - 1, caColorPicture,                                          UT_TYPE_ULONG, 8, &u8Begtime,                                          UT_TYPE_ULONG, 8, &u8Endtime,                                          UT_TYPE_ULONG, 8, &u8Timeval,                                          UT_TYPE_STRING, sizeof(caCuser) - 1, caCuser,                                          UT_TYPE_STRING, sizeof(caContent) - 1, caContent)) || 1405 == iret)        {            iNum++;            if(iNum > 1)            {                utPltPutLoopVar(psDbHead, "dh", iNum, ",");            }            utPltPutLoopVarF(psDbHead, "packageid", iNum, "%lu", u4Packageid);            utPltPutLoopVar(psDbHead, "namech", iNum, convert("GBK", "UTF-8", caNamech));            utPltPutLoopVar(psDbHead, "namedes", iNum, convert("GBK", "UTF-8", caNamedes));            utPltPutLoopVarF(psDbHead, "ptype", iNum, "%lu", u4Ptype);            utPltPutLoopVarF(psDbHead, "pdays", iNum, "%d", iPdays);            utPltPutLoopVarF(psDbHead, "money", iNum, "%lu", u4Money);            utPltPutLoopVar(psDbHead, "picture", iNum,  caPicture);            utPltPutLoopVar(psDbHead, "colorpicture", iNum,  caColorPicture);            snprintf(caBegtime, sizeof(caBegtime) - 1, "%s", utTimFormat("%Y-%m-%d", u8Begtime));            utPltPutLoopVar(psDbHead, "begtime", iNum, caBegtime);            snprintf(caEndtime, sizeof(caEndtime) - 1, "%s", utTimFormat("%Y-%m-%d", u8Endtime));            utPltPutLoopVar(psDbHead, "endtime", iNum, caEndtime);            utPltPutLoopVar(psDbHead, "cuser", iNum,  caCuser);            utPltPutLoopVar(psDbHead, "content", iNum,  caContent);            snprintf(caMsg, sizeof(caMsg) - 1, "查询成功!");            utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));            utPltPutVarF(psDbHead, "result", "%d", 0);        }        pasDbCloseCursor(psCur);    }    else    {        snprintf(caMsg, sizeof(caMsg) - 1, "sql语句执行错误!");        utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));        utPltPutVarF(psDbHead, "result", "%d", 3);//sql语句执行错误        utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/package/all_package.htm");        return 0;    }    utPltPutVarF(psDbHead, "TotRec", "%lu", iNum);    utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/package/all_package.htm");    return 0;}int ict_AuthMobile(utShmHead *psShmHead, int iFd, utMsgHead *psMsgHead){    int iReturn = 0;    utMsgPrintMsg(psMsgHead);    char caVname[32 + 1] = "";    char caPasswd[24 + 1] = "";    char sqlbuf[1024] = "";    ulong lCount = 0;    char caMsg[256] = "";    long wpDebug = utComGetVar_ld(psShmHead, "wpDebug", 0);    iReturn = utMsgGetSomeNVar(psMsgHead, 2,                               "vname",   UT_TYPE_STRING, sizeof(caVname) - 1, caVname,                               "passwd",  UT_TYPE_STRING, sizeof(caPasswd) - 1, caPasswd                              );    utStrDelSpaces(caVname);    utPltDbHead* psDbHead = utPltInitDb();    if(strlen(caVname) > 0)    {        memset(sqlbuf, 0, sizeof(sqlbuf));        snprintf(sqlbuf, sizeof(sqlbuf) - 1, "select count(*) from ncsrvuser where username='%s' and password='%s'", caVname, caPasswd);        ictPrint(wpDebug, "sqlbuf=%s  \n", sqlbuf);        pasDbOneRecord(sqlbuf, 0, UT_TYPE_LONG, 4, &lCount);        if(lCount <= 0)        {            snprintf(caMsg, sizeof(caMsg) - 1, "用户名不存在或密码错误", caVname);            utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));            utPltPutVarF(psDbHead, "result", "%d", 1);        }        else        {            //将用户加入共享内存            addUserToShm(caVname);            utPltPutVarF(psDbHead, "result", "%d", 0);            uint8 llTsid = getTsidByVname(psShmHead, caVname);            utPltPutVarF(psDbHead, "tsid", "%llu", llTsid);        }    }    else    {        snprintf(caMsg, sizeof(caMsg) - 1, "用户名不可以为空");        utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));        utPltPutVarF(psDbHead, "result", "%d", 2);    }    utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/login/login.htm");    return 0;}//在共享内存中获取9位序列号，sn表示serial number序列号char* getSystemShmInfoSn(utShmHead *psShmHead){    static char ordernoSn[32] = ""; //套餐订单号序列号    char ordernoSnKey[24] = ""; //套餐订单号序列号的key值    unsigned long u4OrdernoSnKey = 0;//int序列号作为中间转换    snprintf(ordernoSnKey, 23, "%s", "packageOrderNoSnKey");    pasHashInfo sHashInfo;    uchar *pHash = NULL;    systemShmInfo* pSystemShmInfo = NULL;    pHash = (unsigned char *)utShmHashHead(psShmHead, ICT_SHM_INFO);    if(pHash == NULL)    {        utShmFreeHash(psShmHead, ICT_SHM_INFO);        utShmHashInit(psShmHead, ICT_SHM_INFO, 2000, 2000, sizeof(systemShmInfo), 0, 32);    }    //通过key寻找序列号    systemShmInfo* psData = (systemShmInfo*)utShmHashLookA(psShmHead, ICT_SHM_INFO, ordernoSnKey);    if(psData)    {        if(strlen(psData->shmInfoValue) > 0)        {            //将序列号自增1,再转换成字符串,赋值给ordernoSn            //snprintf(u4OrdernoSnKey,31, "%lu",u4OrdernoSnKey);            u4OrdernoSnKey = (strtoul(psData->shmInfoValue, 0, 0) + 1);            printf("加1后序列号为====================================:%lu\n", u4OrdernoSnKey);            snprintf(psData->shmInfoValue, 31, "%lu", u4OrdernoSnKey);            snprintf(ordernoSn, 31, "%lu", u4OrdernoSnKey);            return ordernoSn;        }        else        {            snprintf(psData->shmInfoValue, 31, "100000000");            snprintf(ordernoSn, 31, "%s", psData->shmInfoValue);            return ordernoSn;        }    }}char * createOrderNo(utShmHead *psShmHead){    //订单号的生成方式:当前时间戳+9位序列号    static char orderno[32] = "";    char orderNoTime[32] = "";    char ordernoSn[32] = ""; //套餐订单号序列号    snprintf(orderNoTime, 31, "%llu", time(0)); //将time(0)转化为字符串    snprintf(ordernoSn, 31, "%s", getSystemShmInfoSn(psShmHead)); //将time(0)转化为字符串    //char str[256]="";    //snprintf(str, sizeof(str)-1, "20151112001212%d",1);    snprintf(orderNoTime + strlen(orderNoTime), sizeof(orderNoTime) - 1 - strlen(orderNoTime), ordernoSn);    snprintf(orderno, 31, "%s", orderNoTime);    return orderno;}//将订单信息写到共享内存中char* setOrderInfoToShm(utShmHead *psShmHead, int effectType, int paymentType, uint4 packageid, char *caAutoxiding){    static char orderno[32] = "";    pasHashInfo sHashInfo;    uchar *pHash = NULL;    ictOrderNo* psOrderNo = NULL;    pHash = (unsigned char *)utShmHashHead(psShmHead, ICT_ORDER_PACKAGE_ORDERNO);    if(pHash == NULL)    {        utShmFreeHash(psShmHead, ICT_ORDER_PACKAGE_ORDERNO);        utShmHashInit(psShmHead, ICT_ORDER_PACKAGE_ORDERNO, 2000, 2000, sizeof(ictOrderNo), 0, 32);    }    //生成订单号    snprintf(orderno, 31, "%s", createOrderNo(psShmHead));    ictOrderNo* psData = (ictOrderNo*)utShmHashLookA(psShmHead, ICT_ORDER_PACKAGE_ORDERNO, orderno);    if(psData)    {        snprintf(psData->orderno, 31, "%s", orderno);        psData->effectType = effectType;        psData->paymentType = paymentType;        psData->packageid = packageid;        snprintf(psData->autoxiding, 3, "%s", caAutoxiding);        psData->status = 0;        printf("packageid=====================%d\n", packageid);    }    return orderno;}//生成订单接口int ict_create_package_order(utShmHead *psShmHead, int iFd, utMsgHead *psMsgHead){    utMsgPrintMsg(psMsgHead);//在终端打印出信息    char caUsername[32] = {0};//虚拟身份号，现已改为username    char caPassword[32] = {0};//账户密码    uint8 u8TimeVal = 0;//套餐生效日期    char caTimeVal[16] = {0};//套餐生效日期(临时参数)    uint4 u4PackageId = 0;//新的套餐id    char caPackageId[16] = {0};//新的套餐id(临时参数)    uint4 u4UserPackageId = 0;//旧的套餐id(userpackage的id)    char caUserPackageId[16] = {0};//旧的套餐id(userpackage的id,临时参数)    char caStatus[4] = {0};//userpackage的状态    char caOrderno[32] = ""; //生成的订单号    uint4 u4PackageMoney = 0;//套餐金额    uint4 u4Pdays = 0;//套餐天数    uint4 u4AccountMoney = 0;//账户余额    uint8 u8EndTime = 0;//套餐结束时间    int iDstatus = 1;//订购状态，更改套餐的订购状态为已支付    uint8 u8Dtime = time(0);//订购时间为当前系统时间    char caPaymentType[4] = "";//订购套餐支付方式，1为余额,2为银行转账,3为支付宝,4为微信    char caEffectType[4] = "";//套餐生效方式,1为立即生效,2为原套餐结束后生效    char caAutoxiding[4] = {0};//是否自动续订,1为自动续订,0为不自定续订    int iPaymentType = 0;//订购套餐支付方式(int型,方便比较)    int iEffectType = 0;//套餐生效方式(int型，方便比较)    unsigned long lSign = 0;//前后台校验变量,支付签名    ulong lCount = 0;    char caMsg[256] = {0};    char caTsid[24] = {0};    int iReturn = 0;    utMsgGetSomeNVar(psMsgHead, 6,                     "packageid", UT_TYPE_STRING, 15, caPackageId,                     "paymentType", UT_TYPE_STRING, 3, caPaymentType,                     "effectType", UT_TYPE_STRING, 3, caEffectType,                     "autoxiding", UT_TYPE_STRING, 3, caAutoxiding,                     "password", UT_TYPE_STRING, 31, caPassword,                     "tsid", UT_TYPE_STRING,  sizeof(caTsid) - 1, caTsid);    char sqlbuf[1024] = "";    utPltDbHead *psDbHead = utPltInitDbHead();    if(checkTsid(psShmHead, psDbHead, psMsgHead, iFd, caTsid, "school/package/create_order_no.htm"))    {        return 0;    }    //通过tsid找到对应的username    strcpy(caUsername, getVnameByTsId(psShmHead, atoll(caTsid)));    //验证用户订购套餐时输入的密码是否正确    memset(sqlbuf, 0, sizeof(sqlbuf));    snprintf(sqlbuf, sizeof(sqlbuf) - 1, "select count(*) from ncsrvuser where username='%s' and password='%s'", caUsername, caPassword);    pasDbOneRecord(sqlbuf, 0, UT_TYPE_LONG, 4, &lCount);    pasLogs(1234, 1233, "check passwoed sql =%s\n", sqlbuf);    if(lCount <= 0)    {        snprintf(caMsg, sizeof(caMsg) - 1, "用户输入的登录密码错误");        utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));        utPltPutVarF(psDbHead, "result", "%d", 6);        utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/package/create_order_no.htm");        return 1;    }    else    {    }    //将临时变量赋值到真实变量    u8TimeVal = strtoull(caTimeVal , 0 , 10);    u4PackageId = strtoul(caPackageId , 0 , 10);    u4UserPackageId = strtoul(caUserPackageId , 0 , 10);    iPaymentType = atoi(caPaymentType);    iEffectType = atoi(caEffectType);    if(iPaymentType == 1)//如果付款方式为余额付款,则验证余额是否充足    {        //第一步:通过username来在package数据库中获取套餐金额和套餐天数        memset(sqlbuf, 0, sizeof(sqlbuf));        snprintf(sqlbuf, sizeof(sqlbuf), "select money,pdays from package where id=%u", u4PackageId);        iReturn = pasDbOneRecord(sqlbuf, 0, UT_TYPE_LONG, 4, &u4PackageMoney,                                 UT_TYPE_LONG, 4, &u4Pdays);        printf("sqlbuf=%s, iReturn=%d\n", sqlbuf, iReturn);        //sql语句执行成功        if((iReturn == 0) || (1405 == iReturn))        {            //查询套餐金额和套餐天数天数成功        }        else        {            snprintf(caMsg, sizeof(caMsg) - 1, "查询套餐金额和套餐天数失败!,sql语句执行不成功!");            utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));            utPltPutVarF(psDbHead, "result", "%d", 3);            utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/package/create_order_no.htm");            return 1;        }        //第二步，通过sql语句在userlib表中获取用户余额        memset(sqlbuf, 0, sizeof(sqlbuf));        snprintf(sqlbuf, sizeof(sqlbuf), "select money from ncsrvuserex where username='%s'", caUsername);        iReturn = pasDbOneRecord(sqlbuf, 0, UT_TYPE_LONG, 4, &u4AccountMoney);        printf("sqlbuf=%s, iReturn=%d\n", sqlbuf, iReturn);        //sql语句执行成功        if((iReturn == 0) || (1405 == iReturn))        {            //查询余额成功        }        else        {            snprintf(caMsg, sizeof(caMsg) - 1, "查询余额失败!,sql语句执行不成功");            utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));            utPltPutVarF(psDbHead, "result", "%d", 4);            utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/package/create_order_no.htm");            return 1;        }        if(u4AccountMoney >= u4PackageMoney)        {            //账户余额大于等于套餐金额。可以生成订单            //设置共享内存的订单信息(放在判断外面)        }        else        {            //账户余额小于套餐金额，生成订单失败,直接结束,返回提示信息            snprintf(caMsg, sizeof(caMsg) - 1, "账户余额不足,生成订单失败");            utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));            utPltPutVarF(psDbHead, "result", "%d", 5);            utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/package/create_order_no.htm");            return 1;        }    }    //设置共享内存的订单信息u4PackageId    snprintf(caOrderno, sizeof(caOrderno) - 1, "%s", setOrderInfoToShm(psShmHead, iEffectType, iPaymentType, u4PackageId, caAutoxiding));    snprintf(caMsg, sizeof(caMsg) - 1, "订单生成成功");    utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));    utPltPutVarF(psDbHead, "result", "%d", 0);    //生成前后台校验变量sign    //sprintf(caTemp,"%d_%s",lGroupid,caVname);    lSign = utMd5Code(caOrderno, strlen(caOrderno), "hjj123");    printf("lSign=============================%lu\n", lSign);    utPltPutVar(psDbHead, "orderPackageNo", convert("GBK", "UTF-8", caOrderno));    utPltPutVarF(psDbHead, "orderPackageSign", "%lu", lSign);    utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/package/create_order_no.htm");    return 0;}//是否可以订购套餐(处于生效状态的套餐的个数只能是两个以内)int ict_is_can_order_package(utShmHead *psShmHead, int iFd, utMsgHead *psMsgHead){    utMsgPrintMsg(psMsgHead);//在终端打印出信息    char caUsername[32] = {0};//虚拟身份号，现已改为username    ulong lCount = 0;    char caMsg[256] = {0};    char caTsid[24] = {0};    int iReturn = 0;    //uint8 u8NowTime = 0;//系统当前时间戳    char caStatus[4] = {0};//userorder的状态,1生效,2失效    utMsgGetSomeNVar(psMsgHead, 1,                     "tsid", UT_TYPE_STRING,  sizeof(caTsid) - 1, caTsid);    char sqlbuf[1024] = "";    utPltDbHead *psDbHead = utPltInitDbHead();    if(checkTsid(psShmHead, psDbHead, psMsgHead, iFd, caTsid, "school/package/is_can_order_package.htm"))    {        return 0;    }    snprintf(caUsername, sizeof(caUsername) - 1, "%s", getVnameByTsId(psShmHead, atoll(caTsid))); //根据tsid获取username    memset(sqlbuf, 0, sizeof(sqlbuf));    snprintf(caStatus, sizeof(caStatus) - 1, "1"); //将生效状态字段改为生效,用于sql语句查询    snprintf(sqlbuf, sizeof(sqlbuf) - 1, "select count(*) from userorder where username='%s' and status='%s'", caUsername, caStatus);    printf("sqlbuf======================%s\n", sqlbuf);    pasDbOneRecord(sqlbuf, 0, UT_TYPE_LONG, 4, &lCount);    if(lCount <= 1)    {        snprintf(caMsg, sizeof(caMsg) - 1, "可以订购套餐");        utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));        utPltPutVarF(psDbHead, "result", "%d", 0);        utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/package/is_can_order_package.htm");    }    else    {        snprintf(caMsg, sizeof(caMsg) - 1, "订购套餐数量已达上限，不可再订购");        utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));        utPltPutVarF(psDbHead, "result", "%d", 3);        utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/package/is_can_order_package.htm");    }    return 0;}int ict_complete_package_order(utShmHead *psShmHead, int iFd, utMsgHead *psMsgHead){    utMsgPrintMsg(psMsgHead);//在终端打印出信息    char caUsername[32] = {0};//虚拟身份号，现已改为username    char caMobno[24] = {0};//用户绑定的手机号    char caMark[128] = {0}; //产品标示    uint8 u8TimeVal = 0;//套餐生效日期    char caTimeVal[16] = {0};//套餐生效日期(临时参数)    uint4 u4PackageId = 0;//新的套餐id    char caPackageName[32] = {0};//新的套餐名称    char caAutoxiding[4] = {0};//是否自动续订,1为自动续订,0为不自定续订    char caPackageId[16] = {0};//新的套餐id(临时参数)    uint4 u4UserPackageId = 0;//旧的套餐对应在userorderid的主键id    char caUserPackageId[16] = {0};//旧的套餐id(userpackage的id,临时参数)    char caStatus[4] = {0};//userorder的状态,1生效,2失效    char caOrderno[32] = ""; //生成的订单号    char caPackageTransactionNo[24] = "";//支付接口提供方的交易号    //要通过sql语句获取的变量    uint4 u4PackageMoney = 0;//套餐金额    uint4 u4OldPackageMoney = 0;//原套餐金额    uint4 u4Pdays = 0;//套餐天数    uint4 u4OldAccountMoney = 0;//订购前的账户余额    //通过计算获得的变量    uint8 u8StartTime = 0;//套餐开始时间    uint8 u8EndTime = 0;//套餐结束时间    uint8 u8OldPackageEndTime = 0;//当前旧套餐的结束时间    uint8 u8NowTime = 0;//系统当前时间戳    int iDstatus = 1;//订购状态，更改套餐的订购状态为已支付    uint8 u8Dtime = time(0);//订购时间为当前系统时间    char caPaymentType[4] = "";//订购套餐支付方式，1为余额,2为银行转账,3为支付宝,4为微信    char caEffectType[4] = "";//套餐生效方式,1为立即生效,2为原套餐结束后生效    int iPaymentType = 0;//订购套餐支付方式(int型,方便比较)    int iEffectType = 0;//套餐生效方式(int型，方便比较)    ulong lCount = 0;    char caMsg[256] = {0};    char caTsid[24] = {0};    int iReturn = 0;    char caUserorderTableName[128] = {0};//当月的用户订购套餐日志表名    char caStemptime[32] = {0};//当月的时间格式(%Y%m)    char userOrderLogType[4] = {0};//订购套餐日志类型,1为订购,2为升级    uint4 u4NewAccountMoney = 0;//余额付款，更新后的账户余额    char caOldPackageName[32] = {0};//旧的套餐名称    //获取前台发送的数据    utMsgGetSomeNVar(psMsgHead, 2,                     "orderPackageNo", UT_TYPE_STRING, 31, caOrderno,                     "tsid", UT_TYPE_STRING,  sizeof(caTsid) - 1, caTsid);    pasLogs(1223, 1223, " in  ict_complete_package_order\n");    char sqlbuf[1024] = "";    utPltDbHead *psDbHead = utPltInitDbHead();    //验证tsid是否正确    if(checkTsid(psShmHead, psDbHead, psMsgHead, iFd, caTsid, "school/package/complete_package_order.htm"))    {        return 0;    }    //验证从前台传过来的orderPackageNo在共享内存中是否存在    pasHashInfo sHashInfo;    uchar *pHash;    ictOrderNo* psData = (ictOrderNo*)utShmHashLookA(psShmHead, ICT_ORDER_PACKAGE_ORDERNO, caOrderno);    if(((psData->packageid) > 0) && (psData->status == 0))    {        iPaymentType = psData->paymentType;        iEffectType = psData->effectType;        u4PackageId = psData->packageid;        snprintf(caAutoxiding, 3, "%s", psData->autoxiding);        psData->status = 1;//将订单状态设置为已完成    }    else    {        //套餐订单不存在        snprintf(caMsg, sizeof(caMsg) - 1, "订单号不存在或已完成");        utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));        utPltPutVarF(psDbHead, "result", "%d", 3);        utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/package/complete_package_order.htm");        return 1;    }    //获取新套餐的相关信息    memset(sqlbuf, 0, sizeof(sqlbuf));    snprintf(sqlbuf, sizeof(sqlbuf) - 1, "select money,namech,pdays from package where id=%u", u4PackageId);    iReturn = pasDbOneRecord(sqlbuf, 0, UT_TYPE_LONG, 4, &u4PackageMoney,                             UT_TYPE_STRING, sizeof(caPackageName) - 1, caPackageName,                             UT_TYPE_LONG, 4, &u4Pdays);    printf("sqlbuf=%s, iReturn=%d\n", sqlbuf, iReturn);    //sql语句执行成功    if((iReturn == 0) || (1405 == iReturn))    {        //获取新套餐的相关信息成功    }    else    {        snprintf(caMsg, sizeof(caMsg) - 1, "查询新的套餐信息失败!,sql语句执行不成功!");        utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));        utPltPutVarF(psDbHead, "result", "%d", 7);        utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/package/complete_package_order.htm");        return 1;    }    //首先在数据库中获取用户当前生效的套餐    snprintf(caUsername, sizeof(caUsername) - 1, "%s", getVnameByTsId(psShmHead, atoll(caTsid))); //根据tsid获取username    memset(sqlbuf, 0, sizeof(sqlbuf));    u8NowTime = time(0); //获取当前时间戳    snprintf(caStatus, sizeof(caStatus) - 1, "1"); //将生效状态字段改为生效,用于sql语句查询    /*select获取的数据说明     money作为用户用余额付款时，计算付款后的账户余额,并将余额返回到前台,前台更新账户余额    */    //printf("sqlbuf before======================%s\n", sqlbuf);    snprintf(sqlbuf, sizeof(sqlbuf) - 1, "select ncsrvuserex.money,ncsrvuserex.mobno,userorder.id,userorder.endtime from ncsrvuserex,userorder where ncsrvuserex.username='%s' and userorder.username='%s' and userorder.starttime <= %llu and userorder.endtime >= %llu and userorder.status='%s'", caUsername, caUsername, u8NowTime, u8NowTime, caStatus);    //ictPrint(wpDebug, "sql=%s    \n", sqlbuf);    //printf("sqlbuf======================%s\n", sqlbuf);    //将调试信息打印到日志文件中    pasLogs(PAS_SRCFILE, 1000, "sqlbuf=%s  \n", sqlbuf);    iReturn = pasDbOneRecord(sqlbuf, 0, UT_TYPE_LONG, 4, &u4OldAccountMoney, //订购套餐前的的账户余额                             UT_TYPE_STRING, sizeof(caMobno) - 1, caMobno,                             UT_TYPE_LONG, 4, &u4UserPackageId,                             UT_TYPE_LONG, 8, &u8OldPackageEndTime                            );    printf("sqlbuf=%s, iReturn=%d\n", sqlbuf, iReturn);    if((iReturn == 0) || (1405 == iReturn) || (1403 == iReturn))    {        //查询用户是否有当前生效套餐        if(strlen(caMobno) > 0)//存在当前生效套餐        {            //如果是立即生效的话，将当前套餐状态改为失效            if(iEffectType == 1)            {                //设置userorder的状态为2，失效                snprintf(caStatus, sizeof(caStatus) - 1, "2");                memset(sqlbuf, 0, sizeof(sqlbuf));                //根据userorder的id(主键)来更新数据                snprintf(sqlbuf, sizeof(sqlbuf), "update userorder set status='%s' where id =%u", caStatus, u4UserPackageId);                //printf("sqlbuf======================%s\n", sqlbuf);                pasLogs(PAS_SRCFILE, 1000, "sqlbuf=%s  \n", sqlbuf);                iReturn = pasDbExecSql(sqlbuf, 0);                memset(caMsg, 0, sizeof(caMsg));                if(iReturn != 0)                {                    snprintf(caMsg, sizeof(caMsg) - 1, "用户订购套餐的生效状态修改失败!,sql语句执行不成功!");                    utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));                    utPltPutVarF(psDbHead, "result", "%d", 5);                    utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/package/complete_package_order.htm");                    pasDbRollback(NULL);//错误回滚                    return 1;                }                else                {                    //userorder表套餐生效状态修改成功                }                //设置订购套餐的生效时间为当前时间                u8StartTime = time(0);            }            else//原套餐结束后生效            {                //设置订购套餐的生效时间,为当前旧套餐的结束时间                u8StartTime = u8OldPackageEndTime;            }        }        else//没有当前生效的套餐        {            //设置订购套餐的生效时间为当前时间            u8StartTime = time(0);        }        //余额付款        if(iPaymentType == 1)        {            u4NewAccountMoney = u4OldAccountMoney - u4PackageMoney;//计算扣款后的余额(数据库中以分为单位，传到前台的是分为单位)            pasLogs(1223, 1223, " u4NewAccountMoney =%lu\n", u4NewAccountMoney);            pasLogs(1223, 1223, " u4OldAccountMoney =%lu\n", u4OldAccountMoney);            pasLogs(1223, 1223, " u4PackageMoney =%lu\n", u4PackageMoney);            printf("u4OldAccountMoney=%lu\n", u4OldAccountMoney);            printf("u4PackageMoney=%lu\n", u4PackageMoney);            printf("u4NewAccountMoney=%lu\n", u4NewAccountMoney);            //执行余额付款            memset(sqlbuf, 0, sizeof(sqlbuf));            snprintf(sqlbuf, sizeof(sqlbuf) - 1, "update ncsrvuserex set money=%lu where username ='%s'", u4NewAccountMoney, caUsername);            //printf("sqlbuf===========================%s\n", sqlbuf);            pasLogs(PAS_SRCFILE, 1000, "sqlbuf=%s  \n", sqlbuf);            iReturn = pasDbExecSql(sqlbuf, 0);            memset(caMsg, 0, sizeof(caMsg));            if(iReturn != 0)            {                snprintf(caMsg, sizeof(caMsg) - 1, "用户余额修改失败!,sql语句执行不成功!");                utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));                utPltPutVarF(psDbHead, "result", "%d", 6);//用户余额修改失败                utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/package/complete_package_order.htm");                pasDbRollback(NULL);//错误回滚                return 1;            }            else            {                //用户余额修改成功!            }        }        else        {            //不是余额付款,不做操作        }    }    else    {        snprintf(caMsg, sizeof(caMsg) - 1, "查询用户是否有当前生效套餐!,sql语句执行不成功!");        utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));        utPltPutVarF(psDbHead, "result", "%d", 4);        utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/package/complete_package_order.htm");        return 1;    }    //公共调用的模块    //模块一、添加用户订购套餐信息    u8EndTime = u8StartTime + (u4Pdays * 24 * 60 * 60);    //获取产品标识mark    snprintf(caMark, sizeof(caMark) - 1, "%s", utComGetVar_sd(psShmHead, "mark", "0"));    printf("caMark=====================%s\n", caMark);    //snprintf(caAutoxiding, sizeof(caAutoxiding) - 1, "0");    //设置套餐状态，设置为1.生效    snprintf(caStatus, sizeof(caStatus) - 1, "1");    //设置订购时间    u8Dtime = time(0);    memset(sqlbuf, 0, sizeof(sqlbuf));    printf("insert into userorder==========================================\n");    snprintf(sqlbuf, sizeof(sqlbuf), "insert into userorder (username,mobno,mark,packageid,name,starttime,endtime,autoxiding,status,timeval)values('%s','%s','%s',%lu,'%s',%llu,%llu,'%s','%s',%llu)", caUsername, caMobno, caMark, u4PackageId, caPackageName, u8StartTime, u8EndTime, caAutoxiding, caStatus, u8Dtime);    //printf("sqlbuf=%s, iReturn=%d\n", sqlbuf, iReturn);    pasLogs(PAS_SRCFILE, 1000, "sqlbuf=%s, iReturn=%d\n", sqlbuf, iReturn);    iReturn = pasDbExecSql(sqlbuf, 0);    memset(caMsg, 0, sizeof(caMsg));    if(iReturn != 0)    {        snprintf(caMsg, sizeof(caMsg) - 1, "添加用户订购套餐信息!,sql语句执行不成功!");        utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));        utPltPutVarF(psDbHead, "result", "%d", 8);        utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/package/complete_package_order.htm");        pasDbRollback(NULL);//错误回滚        return 1;    }    else    {        //添加用户订购套餐信息成功    }    //模块二、添加用户订购套餐日志    //获得用户订购套餐日志表名,没有则创建    long letime = time(0);    snprintf(caStemptime, sizeof(caStemptime) - 1, "%s", utTimFormat("%Y%m", letime));    printf("caStemptime=======================%s\n", caStemptime);    snprintf(caUserorderTableName, sizeof(caUserorderTableName) - 1, "%s", getNewLogTable("userorderlog", caStemptime));    memset(sqlbuf, 0, sizeof(sqlbuf));    //获取日志表名    printf("caUserorderTableName=======================%s\n", caUserorderTableName);    //设置日志类型,这里设置为1,为订购    snprintf(userOrderLogType, sizeof(userOrderLogType) - 1, "1");    printf("sqlbuf=%s, iReturn=%d\n", sqlbuf, iReturn);    snprintf(sqlbuf, sizeof(sqlbuf), "insert into %s (username,mobno,mark,packageid,name,status,money,mtype,timeval,orderno,starttime,endtime)values('%s','%s','%s',%lu,'%s','%s',%lu,%d,%llu,'%s',%llu,%llu)", caUserorderTableName, caUsername, caMobno, caMark, u4PackageId, caPackageName, userOrderLogType, u4PackageMoney, iPaymentType, u8Dtime, caOrderno, u8StartTime, u8EndTime);    //printf("%s\n", sqlbuf);    pasLogs(PAS_SRCFILE, 1000, "sqlbuf=%s, iReturn=%d\n", sqlbuf, iReturn);    iReturn = pasDbExecSql(sqlbuf, 0);    printf("sqlbuf=%s, iReturn=%d\n", sqlbuf, iReturn);    memset(caMsg, 0, sizeof(caMsg));    if(iReturn != 0)    {        snprintf(caMsg, sizeof(caMsg) - 1, "添加用户订购套餐日志失败,sql语句执行不成功!");        utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));        utPltPutVarF(psDbHead, "result", "%d", 9);        utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/package/complete_package_order.htm");        pasDbRollback(NULL);//错误回滚        return 1;    }    else    {        //添加用户订购套餐日志成功        snprintf(caMsg, sizeof(caMsg) - 1, "订购套餐执行成功!");        utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));        utPltPutVarF(psDbHead, "result", "%d", 0);        //余额付款返回更新后的余额,如果不是余额付款,也返回目前账户的余额，以套餐付款方式区分        utPltPutVarF(psDbHead, "accountBalance", "%lu", u4NewAccountMoney);        utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/package/complete_package_order.htm");        pasDbCommit(NULL);//事物提交    }	return 0;}//显示常见问题int ict_show_common_questions(utShmHead * psShmHead, int iFd, utMsgHead * psMsgHead){#if SERVICE_INFO    utMsgPrintMsg(psMsgHead);#endif    char caQuestionTitle[64] = {0}; //问题标题    char caQuestionContent[256] = {0}; //问题内容    uint8 u8Timeval = 0;//问题添加时间    char caCuser[32] = {0}; //管理员    int iReturn = 0;    char caMsg[256] = {0};    char caTsid[24] = {0};    char sql[1024] = {0};    int db_count = 0; //获取数据的条数    int iret = -1;    int iNum = 0;    char start_in[8] = {0};    char limit_in[8] = {0};    //获取tsid,验证用户登录状态    utMsgGetSomeNVar(psMsgHead, 3,                     "start",    UT_TYPE_STRING,  sizeof(start_in) - 1,    start_in,                     "limit",     UT_TYPE_STRING,      sizeof(limit_in) - 1,    limit_in,                     "tsid",      UT_TYPE_STRING,      sizeof(caTsid) - 1, caTsid);    pasDbCursor *psCur = NULL;    utPltDbHead *psDbHead = utPltInitDb();    if(checkTsid(psShmHead, psDbHead, psMsgHead, iFd, caTsid, "school/support/show_common_question.htm"))    {        return 0;    }    //处理前台不上传start，limit的情况，设置默认值    if(strlen(start_in) == 0)    {        snprintf(start_in, sizeof(start_in) - 1, "0");    }    if(strlen(limit_in) == 0)    {        snprintf(limit_in, sizeof(limit_in) - 1, "10");    }    snprintf(sql, sizeof(sql) - 1, "select questionTitle,questionContent,timeval,cuser from tCommonQuestion limit %u,%u", atoi(start_in), atoi(limit_in));    printf("sql===========================================%s\n", sql);    psCur = pasDbOpenSql(sql, 0);    if(psCur != NULL)    {        while(0 == (iret = pasDbFetchInto(psCur,                                          UT_TYPE_STRING, sizeof(caQuestionTitle) - 1, caQuestionTitle,                                          UT_TYPE_STRING, sizeof(caQuestionContent) - 1, caQuestionContent,                                          UT_TYPE_ULONG, 8, &u8Timeval,                                          UT_TYPE_STRING, sizeof(caCuser) - 1, caCuser)) || 1405 == iret)        {            iNum++;            if(iNum > 1)            {                utPltPutLoopVar(psDbHead, "dh", iNum, ",");            }            utPltPutLoopVar(psDbHead, "questionTitle", iNum, convert("GBK", "UTF-8", caQuestionTitle));            utPltPutLoopVar(psDbHead, "questionContent", iNum, convert("GBK", "UTF-8", caQuestionContent));            utPltPutLoopVarF(psDbHead, "timeval", iNum, "%llu", u8Timeval);            utPltPutLoopVar(psDbHead, "cuser", iNum,  caCuser);            snprintf(caMsg, sizeof(caMsg) - 1, "查询成功!");            utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));            utPltPutVarF(psDbHead, "result", "%d", 0);        }        pasDbCloseCursor(psCur);    }    else    {        snprintf(caMsg, sizeof(caMsg) - 1, "sql语句执行错误!");        utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));        utPltPutVarF(psDbHead, "TotRec", "%lu", iNum);        utPltPutVarF(psDbHead, "result", "%d", 3);//sql语句执行错误        utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/support/show_common_question.htm");        return 1;    }    if(0 == iNum)//如果数据库表中数据为空    {        snprintf(caMsg, sizeof(caMsg) - 1, "数据库表中数据为空");        utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));        utPltPutVarF(psDbHead, "TotRec", "%lu", iNum);        utPltPutVarF(psDbHead, "result", "%d", 4);        utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/support/show_common_question.htm");        return 1;    }    utPltPutVarF(psDbHead, "TotRec", "%lu", iNum);    utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/support/show_common_question.htm");    return 0;}//添加互动信息int ict_add_interaction_info(utShmHead * psShmHead, int iFd, utMsgHead * psMsgHead){    utMsgPrintMsg(psMsgHead);    char caUsername[32] = {0};//用户名    char caMobno[24] = {0};//用户绑定的手机号    char caMark[128] = {0}; //产品标示    char caStatus[4] = {0};//互动状态,0为新的问题，1为后续交流    char caProblemid[12] = {0};//新问题的id，用于前台发送到服务器的数据    uint4 u4problemid = 0;//新问题的id    char caSubject[128] = {0};//新问题标题    char caContent[256] = {0};//新问题或者回复的内容    uint8 u8Timeval = 0;//操作时间    char caCuser[32] = {8};//管理员    int iReturn = 0;    char caMsg[256] = {0};    char caTsid[24] = {0};    long letime = time(0);//为获取当前月份对应表名，而设置的变量    char caFeedbackTableName[128] = {0};//当月的用户订购套餐日志表名    char caStemptime[32] = {0};//当月的时间格式(%Y%m)    utMsgGetSomeNVar(psMsgHead, 4,                     "problemid", UT_TYPE_STRING, sizeof(caProblemid) - 1, caProblemid,                     "subject", UT_TYPE_STRING, sizeof(caSubject) - 1, caSubject,                     "content", UT_TYPE_STRING, sizeof(caContent) - 1, caContent,                     "tsid", UT_TYPE_STRING, sizeof(caTsid) - 1, caTsid                    );    char sql[1024] = "";    pasDbCursor *psCur = NULL;    utPltDbHead *psDbHead = utPltInitDb();    if(checkTsid(psShmHead, psDbHead, psMsgHead, iFd, caTsid, "school/support/add_interaction_info.htm"))    {        return 0;    }    //获得当前月份所对应的表名    snprintf(caStemptime, sizeof(caStemptime) - 1, "%s", utTimFormat("%Y%m", letime));    printf("caStemptime=======================%s\n", caStemptime);    snprintf(caFeedbackTableName, sizeof(caFeedbackTableName) - 1, "%s", getNewLogTable("feedback", caStemptime));    //在使用sql之前，将sql的清空    memset(sql, 0, sizeof(sql));    //根据tsid获取username    snprintf(caUsername, sizeof(caUsername) - 1, "%s", getVnameByTsId(psShmHead, atoll(caTsid)));    //根据username获取mobno    snprintf(caMobno, sizeof(caMobno) - 1, "%s", getMobnoByUsername(psShmHead, psMsgHead, iFd, caUsername));    //获取产品标识mark    snprintf(caMark, sizeof(caMark) - 1, "%s", utComGetVar_sd(psShmHead, "mark", "0"));    //设置互动信息状态,根据前台传过来的problemid是否为0来判断,如果为零,说明是添加新问题,否则为添加回复    if(strtoul(caProblemid, 0, 0) == 0)    {        snprintf(caStatus, sizeof(caStatus) - 1, "0");    }    else    {        snprintf(caStatus, sizeof(caStatus) - 1, "1");    }    //设置操作时间为当前时间戳    u8Timeval = time(0);    //设置管理员为空，表示这条信息为用户添加的,客服回复的在运营平台中添加    snprintf(caCuser, sizeof(caCuser) - 1, "");    snprintf(sql, sizeof(sql), "insert into %s (username,mobno,mark,status,problemid,subject,content,timeval,cuser)values('%s','%s','%s','%s',%lu,'%s','%s',%llu,'%s')", caFeedbackTableName, caUsername, caMobno, caMark, caStatus, strtoul(caProblemid, 0, 0), convert("UTF-8", "GBK", caSubject), convert("UTF-8", "GBK", caContent), u8Timeval, caCuser);    printf("%s\n", sql);    iReturn = pasDbExecSql(sql, 0);    memset(caMsg, 0, sizeof(caMsg));    if(iReturn != 0)    {        snprintf(caMsg, sizeof(caMsg) - 1, "添加互动信息失败!");        utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));        utPltPutVarF(psDbHead, "result", "%d", 3);//添加互动信息失败!        utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/support/add_interaction_info.htm");    }    else    {        snprintf(caMsg, sizeof(caMsg) - 1, "添加互动信息成功!");        utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));        utPltPutVarF(psDbHead, "result", "%d", 0);        utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/support/add_interaction_info.htm");    }    return  0;}//char * combine_table(char *table)//{//long letime = time(0);//为获取当前月份对应表名，而设置的变量// static char caFeedbackTableName[128] = {0};//当月的用户订购套餐日志表名//char caStemptime[32] = {0};//当月的时间格式(%Y%m)//snprintf(caStemptime,sizeof(caStemptime)-1,"%s", utTimFormat("%Y%m", letime));//return caFeedbackTableName;//}typedef struct{    uint4 u4feedbackid;//互动信息的id    char caUsername[32];//用户名    char caMobno[24];//用户绑定的手机号    char caMark[128];//产品标示    char caStatus[4];//互动状态,0为新的问题，1为后续交流    uint4 u4problemid;//新问题的id    char caSubject[128];//新问题标题    char caContent[256];//新问题或者回复的内容    uint8 u8Timeval;//操作时间    char caCuser[32];//管理员} feedRecord;//显示互动信息int ict_show_feedback_info(utShmHead * psShmHead, int iFd, utMsgHead * psMsgHead){    utMsgPrintMsg(psMsgHead);    char caUsername[32] = {0};//用户名    char caMobno[24] = {0};//用户绑定的手机号    char caMark[128] = {0}; //产品标示    char caStatus[4] = {0};//互动状态,0为新的问题，1为后续交流    char caProblemid[12] = {0};//新问题的id，用于前台发送到服务器的数据    uint4 u4problemid = 0;//新问题的id    uint4 u4feedbackid = 0;//互动信息的id    char caSubject[128] = {0};//新问题标题    char caContent[256] = {0};//新问题或者回复的内容    uint8 u8Timeval = 0;//操作时间    char caTimeval[32] = {0}; //操作时间字符串    char caCuser[32] = {8};//管理员    int iReturn = 0;    char caMsg[256] = {0};    char caTsid[24] = {0};    long letime = time(0);//为获取当前月份对应表名，而设置的变量    char caFeedbackTableName[128] = {0};//当月的用户订购套餐日志表名    char caStemptime[32] = {0};//当月的时间格式(%Y%m)    char begin[24] = "";    char end[24] = "";    char table_name[256] = "";//查询字符串拼接    char sql_tmp[1024] = "";    int iret = -1;    int iNum = 0;    char start_in[8] = {0};    char limit_in[8] = {0};    int ilimit = 10;    ulong lStart = 0, lLimit = 0;    int inumber = 0;    int lCount = 0;    int i = 0;//循环变量    int maxStart = 0;//可以设置的最大start值    utMsgGetSomeNVar(psMsgHead, 4,                     "problemid", UT_TYPE_STRING, sizeof(caProblemid) - 1, caProblemid,                     "tsid", UT_TYPE_STRING, sizeof(caTsid) - 1, caTsid,                     "start", UT_TYPE_STRING, sizeof(start_in) - 1, start_in,                     "limit", UT_TYPE_STRING, sizeof(limit_in) - 1, limit_in                    );    char sql[1024] = "";    pasDbCursor *psCur = NULL;    utPltDbHead *psDbHead = utPltInitDb();    if(checkTsid(psShmHead, psDbHead, psMsgHead, iFd, caTsid, "school/support/show_feedback_info.htm"))    {        return 0;    }    //获得当前月份所对应的表名    snprintf(caStemptime, sizeof(caStemptime) - 1, "%s", utTimFormat("%Y%m", letime));    printf("caStemptime=======================%s\n", caStemptime);    snprintf(caFeedbackTableName, sizeof(caFeedbackTableName) - 1, "%s", getNewLogTable("feedback", caStemptime));    //设置caProblemid为零，来进行查询    //snprintf(caProblemid, sizeof(caProblemid) - 1, "0");    //根据tsid获取username    snprintf(caUsername, sizeof(caUsername) - 1, "%s", getVnameByTsId(psShmHead, atoll(caTsid)));    //获取新问题的相关信息    memset(sql, 0, sizeof(sql));    snprintf(sql, sizeof(sql), "select id,username,mobno,mark,status,problemid,subject,content,timeval,cuser from %s where username='%s' and id=%lu", caFeedbackTableName, caUsername, strtoul(caProblemid, 0, 0));    iReturn = pasDbOneRecord(sql, 0, UT_TYPE_ULONG, 4, &u4feedbackid,                             UT_TYPE_STRING, sizeof(caUsername) - 1, caUsername,                             UT_TYPE_STRING, sizeof(caMobno) - 1, caMobno,                             UT_TYPE_STRING, sizeof(caMark) - 1, caMark,                             UT_TYPE_STRING, sizeof(caStatus) - 1, caStatus,                             UT_TYPE_ULONG, 4, &u4problemid,                             UT_TYPE_STRING, sizeof(caSubject) - 1, caSubject,                             UT_TYPE_STRING, sizeof(caContent) - 1, caContent,                             UT_TYPE_ULONG, 8, &u8Timeval,                             UT_TYPE_STRING, sizeof(caCuser) - 1, caCuser);    printf("sql=%s, iReturn=%d\n", sql, iReturn);    //sql语句执行成功    if((iReturn == 0) || (1405 == iReturn))    {        //获取新问题的相关信息        utPltPutVar(psDbHead, "pSubject", convert("GBK", "UTF-8", caSubject));        utPltPutVar(psDbHead, "pContent", convert("GBK", "UTF-8", caContent));        //utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));        snprintf(caTimeval, sizeof(caTimeval) - 1, "%s", utTimFormat("%Y-%m-%d  %H:%M:%S", u8Timeval));        utPltPutVar(psDbHead, "pTimeval", caTimeval);    }    else    {        snprintf(caMsg, sizeof(caMsg) - 1, "获取新问题的相关信息,sql语句执行不成功!");        utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));        utPltPutVarF(psDbHead, "result", "%d", 3);        utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/package/show_feedback_info.htm");        return 1;    }    memset(sql, 0, sizeof(sql));    snprintf(sql, sizeof(sql) - 1, "select count(*) from %s where username='%s' and problemid=%lu ", caFeedbackTableName, caUsername, strtoul(caProblemid, 0, 0));    pasDbOneRecord(sql, 0, UT_TYPE_LONG, 4, &lCount);    if(lCount == 0)    {        snprintf(caMsg, sizeof(caMsg) - 1, "查询成功!");        utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));        utPltPutVarF(psDbHead, "result", "%d", 0);        utPltPutVarF(psDbHead, "TotRec", "%lu", lCount);        utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/support/show_feedback_info.htm");        return 0;    }    ulong lTotalCount = 0;    lTotalCount = lCount;    //处理前台不上传start，limit的情况，设置默认值    if(strlen(start_in) > 0)    {        lStart = atol(start_in);    }    if(strlen(limit_in) > 0)    {        ilimit = atoi(limit_in);    }    //限制ilimit的值    if(ilimit > lCount)    {        ilimit = lCount;    }    //限制lstart的值    maxStart = (lCount / ilimit) * ilimit;    printf("maxStart==================================%d\n", maxStart);    if(lStart > maxStart)//如果lStart大于最大的有效lStart，说明此页没有数据，直接返回为空    {        //lStart = maxStart;        snprintf(caMsg, sizeof(caMsg) - 1, "查询成功!");        utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));        utPltPutVarF(psDbHead, "result", "%d", 0);        utPltPutVarF(psDbHead, "TotRec", "%lu", lCount);        utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/support/show_feedback_info.htm");        printf("lStart==================================%d\n", lStart);        return 0;    }    lLimit = (ilimit < (lTotalCount - lStart) ? ilimit : (lTotalCount - lStart)); //处理最后一页的    feedRecord* feedList = (feedRecord*)malloc(sizeof(feedRecord) * lLimit);    memset(feedList, 0, sizeof(feedRecord)*lLimit);    //根据caProblemid值的不同，进行不同的操作    snprintf(sql, sizeof(sql) - 1, "select id,username,mobno,mark,status,problemid,subject,content,timeval,cuser from %s where username='%s' and problemid=%lu order by id desc limit %u,%u", caFeedbackTableName, caUsername, strtoul(caProblemid, 0, 0), lStart, ilimit);    printf("sql===========================================%s\n", sql);    psCur = pasDbOpenSql(sql, 0);    if(psCur != NULL)    {        while(0 == (iret = pasDbFetchInto(psCur,                                          UT_TYPE_ULONG, 4, &u4feedbackid,                                          UT_TYPE_STRING, sizeof(caUsername) - 1, caUsername,                                          UT_TYPE_STRING, sizeof(caMobno) - 1, caMobno,                                          UT_TYPE_STRING, sizeof(caMark) - 1, caMark,                                          UT_TYPE_STRING, sizeof(caStatus) - 1, caStatus,                                          UT_TYPE_ULONG, 4, &u4problemid,                                          UT_TYPE_STRING, sizeof(caSubject) - 1, caSubject,                                          UT_TYPE_STRING, sizeof(caContent) - 1, caContent,                                          UT_TYPE_ULONG, 8, &u8Timeval,                                          UT_TYPE_STRING, sizeof(caCuser) - 1, caCuser)) || 1405 == iret)        {            iNum++;            feedList[lLimit - iNum].u4feedbackid = u4feedbackid;            snprintf(feedList[lLimit - iNum].caUsername, sizeof(feedList[lLimit - iNum].caUsername) - 1, caUsername);            snprintf(feedList[lLimit - iNum].caMobno, sizeof(feedList[lLimit - iNum].caMobno) - 1, caMobno);            snprintf(feedList[lLimit - iNum].caMark, sizeof(feedList[lLimit - iNum].caMark) - 1, caMark);            snprintf(feedList[lLimit - iNum].caStatus, sizeof(feedList[lLimit - iNum].caStatus) - 1, caStatus);            feedList[lLimit - iNum].u4problemid = u4problemid;            snprintf(feedList[lLimit - iNum].caSubject, sizeof(feedList[lLimit - iNum].caSubject) - 1, caSubject);            snprintf(feedList[lLimit - iNum].caContent, sizeof(feedList[lLimit - iNum].caContent) - 1, caContent);            feedList[lLimit - iNum].u8Timeval = u8Timeval;            snprintf(feedList[lLimit - iNum].caCuser, sizeof(feedList[lLimit - iNum].caCuser) - 1, caCuser);        }        pasDbCloseCursor(psCur);    }    else    {        snprintf(caMsg, sizeof(caMsg) - 1, "sql语句执行错误!");        utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));        utPltPutVarF(psDbHead, "TotRec", "%lu", iNum);        utPltPutVarF(psDbHead, "result", "%d", 4);//sql语句执行错误        utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/support/show_feedback_info.htm");        return 1;    }    for(i = 0; i < lLimit; i++)    {        if(i > 0)        {            utPltPutLoopVar(psDbHead, "dh", i + 1, ",");        }        utPltPutLoopVarF(psDbHead, "feedbackid", i + 1, "%lu", feedList[i].u4feedbackid);        utPltPutLoopVar(psDbHead, "username", i + 1, feedList[i].caUsername);        utPltPutLoopVar(psDbHead, "mobno", i + 1, feedList[i].caMobno);        utPltPutLoopVar(psDbHead, "mark", i + 1, feedList[i].caMark);        utPltPutLoopVar(psDbHead, "status", i + 1, feedList[i].caStatus);        utPltPutLoopVarF(psDbHead, "problemid", i + 1, "%lu", feedList[i].u4problemid);        utPltPutLoopVar(psDbHead, "subject", i + 1, convert("GBK", "UTF-8", feedList[i].caSubject));        utPltPutLoopVar(psDbHead, "content", i + 1, convert("GBK", "UTF-8", feedList[i].caContent));        snprintf(caTimeval, sizeof(caTimeval) - 1, "%s", utTimFormat("%Y-%m-%d  %H:%M:%S", feedList[i].u8Timeval));        utPltPutLoopVar(psDbHead, "timeval", i + 1, caTimeval);        utPltPutLoopVar(psDbHead, "cuser", i + 1, feedList[i].caCuser);    }    free(feedList);    snprintf(caMsg, sizeof(caMsg) - 1, "查询成功!");    utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));    utPltPutVarF(psDbHead, "result", "%d", 0);    utPltPutVarF(psDbHead, "TotRec", "%lu", lCount);    utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/support/show_feedback_info.htm");    return 0;}//显示对应用户的新问题int ict_show_new_question_info(utShmHead * psShmHead, int iFd, utMsgHead * psMsgHead){    utMsgPrintMsg(psMsgHead);    char caUsername[32] = {0};//用户名    char caMobno[24] = {0};//用户绑定的手机号    char caMark[128] = {0}; //产品标示    char caStatus[4] = {0};//互动状态,0为新的问题，1为后续交流    char caProblemid[12] = {0};//新问题的id，用于前台发送到服务器的数据    uint4 u4problemid = 0;//新问题的id    uint4 u4feedbackid = 0;//互动信息的id    char caTimeval[32] = {0}; //操作时间字符串    char caSubject[128] = {0};//新问题标题    char caContent[256] = {0};//新问题或者回复的内容    uint8 u8Timeval = 0;//操作时间    char caCuser[32] = {8};//管理员    int iReturn = 0;    char caMsg[256] = {0};    char caTsid[24] = {0};    long letime = time(0);//为获取当前月份对应表名，而设置的变量    char caFeedbackTableName[128] = {0};//当月的用户订购套餐日志表名    char caStemptime[32] = {0};//当月的时间格式(%Y%m)    char begin[24] = "";    char end[24] = "";    char table_name[256] = "";//查询字符串拼接    char sql_tmp[1024] = "";    int iret = -1;    int iNum = 0;    char start_in[8] = {0};    char limit_in[8] = {0};    int ilimit = 10;    ulong lStart = 0, lLimit = 0;    int lCount = 0;    utMsgGetSomeNVar(psMsgHead, 3,                     "tsid", UT_TYPE_STRING, sizeof(caTsid) - 1, caTsid,                     "start", UT_TYPE_STRING, sizeof(start_in) - 1, start_in,                     "limit", UT_TYPE_STRING, sizeof(limit_in) - 1, limit_in                    );    char sql[1024] = "";    pasDbCursor *psCur = NULL;    utPltDbHead *psDbHead = utPltInitDb();    if(checkTsid(psShmHead, psDbHead, psMsgHead, iFd, caTsid, "school/support/show_new_question_info.htm"))    {        return 0;    }    //处理前台不上传start，limit的情况，设置默认值    if(strlen(start_in) > 0)    {        lStart = atol(start_in);    }    if(strlen(limit_in) > 0)    {        ilimit = atoi(limit_in);    }    //获得当前月份所对应的表名    snprintf(caStemptime, sizeof(caStemptime) - 1, "%s", utTimFormat("%Y%m", letime));    printf("caStemptime=======================%s\n", caStemptime);    snprintf(caFeedbackTableName, sizeof(caFeedbackTableName) - 1, "%s", getNewLogTable("feedback", caStemptime));    //设置caProblemid为零，来进行查询    //snprintf(caProblemid, sizeof(caProblemid) - 1, "0");    //根据tsid获取username    snprintf(caUsername, sizeof(caUsername) - 1, "%s", getVnameByTsId(psShmHead, atoll(caTsid)));    //设置problemid为零    snprintf(caProblemid, sizeof(caProblemid) - 1, "0");    //获取所有信息的条数    memset(sql, 0, sizeof(sql));    snprintf(sql, sizeof(sql) - 1, "select count(*) from %s where username='%s' and problemid=%lu ", caFeedbackTableName, caUsername, strtoul(caProblemid, 0, 0));    pasDbOneRecord(sql, 0, UT_TYPE_LONG, 4, &lCount);    snprintf(sql, sizeof(sql) - 1, "select id,username,mobno,mark,status,problemid,subject,content,timeval,cuser from %s where username='%s' and problemid=%lu order by id desc limit %u,%u", caFeedbackTableName, caUsername, strtoul(caProblemid, 0, 0), lStart, ilimit);    printf("sql===========================================%s\n", sql);    psCur = pasDbOpenSql(sql, 0);    if(psCur != NULL)    {        while(0 == (iret = pasDbFetchInto(psCur,                                          UT_TYPE_ULONG, 4, &u4feedbackid,                                          UT_TYPE_STRING, sizeof(caUsername) - 1, caUsername,                                          UT_TYPE_STRING, sizeof(caMobno) - 1, caMobno,                                          UT_TYPE_STRING, sizeof(caMark) - 1, caMark,                                          UT_TYPE_STRING, sizeof(caStatus) - 1, caStatus,                                          UT_TYPE_ULONG, 4, &u4problemid,                                          UT_TYPE_STRING, sizeof(caSubject) - 1, caSubject,                                          UT_TYPE_STRING, sizeof(caContent) - 1, caContent,                                          UT_TYPE_ULONG, 8, &u8Timeval,                                          UT_TYPE_STRING, sizeof(caCuser) - 1, caCuser)) || 1405 == iret)        {            iNum++;            if(iNum > 1)            {                utPltPutLoopVar(psDbHead, "dh", iNum, ",");            }            utPltPutLoopVarF(psDbHead, "feedbackid", iNum, "%lu", u4feedbackid);            utPltPutLoopVar(psDbHead, "username", iNum, caUsername);            utPltPutLoopVar(psDbHead, "mobno", iNum, caMobno);            utPltPutLoopVar(psDbHead, "mark", iNum, caMark);            utPltPutLoopVar(psDbHead, "status", iNum, caStatus);            utPltPutLoopVarF(psDbHead, "problemid", iNum, "%lu", u4problemid);            utPltPutLoopVar(psDbHead, "subject", iNum, convert("GBK", "UTF-8", caSubject));            utPltPutLoopVar(psDbHead, "content", iNum, convert("GBK", "UTF-8", caContent));            snprintf(caTimeval, sizeof(caTimeval) - 1, "%s", utTimFormat("%Y-%m-%d  %H:%M:%S", u8Timeval));            utPltPutLoopVar(psDbHead, "timeval", iNum, caTimeval);            utPltPutLoopVar(psDbHead, "cuser", iNum,  caCuser);            snprintf(caMsg, sizeof(caMsg) - 1, "查询成功!");            utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));            utPltPutVarF(psDbHead, "result", "%d", 0);        }        pasDbCloseCursor(psCur);    }    else    {        snprintf(caMsg, sizeof(caMsg) - 1, "sql语句执行错误!");        utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));        utPltPutVarF(psDbHead, "TotRec", "%lu", lCount);        utPltPutVarF(psDbHead, "result", "%d", 3);//sql语句执行错误        utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/support/show_new_question_info.htm");        return 1;    }    utPltPutVarF(psDbHead, "TotRec", "%lu", lCount);    utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/support/show_new_question_info.htm");    return 0;}//将FunName注册到系统中去int ictInitWebFun_hjj(utShmHead * psShmHead){    pasSetTcpFunName("ict_support_help", ict_support_help, 0);    pasSetTcpFunName("ict_show_package", ict_show_package, 0);    pasSetTcpFunName("ict_login", ict_login, 0);    pasSetTcpFunName("ict_system_update_password", ict_system_update_password, 0);    pasSetTcpFunName("ict_change_package", ict_change_package, 0);    //手机端更改套餐接口    pasSetTcpFunName("ict_change_package_mobile", ict_change_package_mobile, 0);    //获取所有套餐信息    pasSetTcpFunName("ict_getAllPackage", ict_getAllPackage, 0);    //手机端登录接口    pasSetTcpFunName("ict_AuthMobile", ict_AuthMobile, 0);    //创建订单接口    pasSetTcpFunName("ict_create_package_order", ict_create_package_order, 0);    //完成订单接口    pasSetTcpFunName("ict_complete_package_order", ict_complete_package_order, 0);    //显示常见问题    pasSetTcpFunName("ict_show_common_questions", ict_show_common_questions, 0);    //添加互动信息，在添加留言时和添加回复时，都可调用，只是传递的参数不一样    pasSetTcpFunName("ict_add_interaction_info", ict_add_interaction_info, 0);    //显示互动信息    pasSetTcpFunName("ict_show_feedback_info", ict_show_feedback_info, 0);    //显示新问题    pasSetTcpFunName("ict_show_new_question_info", ict_show_new_question_info, 0);    //是否可以订购套餐(处于生效状态的套餐的个数只能是两个以内,暂且保留)    pasSetTcpFunName("ict_is_can_order_package", ict_is_can_order_package, 0);    return 0;}