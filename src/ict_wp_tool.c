#include <stdio.h>#include <stdlib.h>#include <string.h>#include <sys/stat.h>#include <string.h>#include <locale.h>#include <unistd.h>#include <sys/types.h>#include <sys/socket.h>#include <netinet/in.h>#include <arpa/inet.h>#include <netdb.h>#include <sys/time.h>#include "utoall.h"#include "utoplt01.h"#include "pasdb.h"#include "ncportal.h"#include <iconv.h>#include <iconv.h>#include <ctype.h>#include <openssl/crypto.h>#include <openssl/ssl.h>#include <openssl/err.h>#include <openssl/rand.h>#include "cjson.h"#include "ict_wp_tool.h"#define DEBUG 1#define PAS_SRCFILE 1066static int2     lReqIdNum = 1;static int      iPapChap = 0;   /* 0--Chap  1-PAP  */static char     caServicecode[32] = "pronetwayshaitest";uint8 getTsidByIp(utShmHead *psShmHead, char* ictIp){    pasHashInfo sHashInfo;    uchar *pHash;    int iReturn = 0;    char outIp[64] = "";    ncPortalOnline  *psOnline;    long long ltsid = 0;    pHash = (unsigned char *)utShmHashHead(psShmHead, NCSRV_LNK_ONLINE);    if(pHash == NULL)    {        return 0;    }    psOnline = (ncPortalOnline *)pasHashFirst(pHash, &sHashInfo);    while(psOnline)    {        pasLogs(1066, 1068, "=======================================================");        pasLogs(1066, 1068, "tsid=%llu,username=[%s], userip=[%s], usermac=[%s]", psOnline->lTsid, psOnline->caName, utComHostIp(psOnline->lSip), pasCvtMac(psOnline->caMac));        pasIpcvtStr(psOnline->lSip, outIp);        pasLogs(1066, 1068, "utComHostIpF ip=[%s], outIp=[%s]", utComHostIpF(psOnline->lSip), outIp);        pasLogs(1066, 1068, "ictIp=[%s],lSip=[%lu], ictIpLong=[%lu]", ictIp, psOnline->lSip, pasIpcvtLong(ictIp));        pasLogs(1066, 1068, "ntohl(psOnline->lSip)=%lu, cvtIp=[%s]", ntohl(psOnline->lSip), utComHostIp(ntohl(psOnline->lSip)));        pasLogs(1066, 1068, "=============================");        if(strcmp(utComHostIp(ntohl(psOnline->lSip)), ictIp) == 0)        {            ltsid = psOnline->lTsid;            break;        }        psOnline = (ncPortalOnline *)pasHashNextS(&sHashInfo);    }    return ltsid;}char *getHttpsXmlConByPost(char *pUrl, char *pPostVar){    int sockfd, ret;    char buffer[1024];    struct sockaddr_in server_addr;    struct hostent *host;    int portnumber, nbytes;    char host_addr[256];    char host_file[1024];    char local_file[256];    char request[1024];    int send, totalsend;    int i;    char *pt;    SSL *ssl;    SSL_CTX *ctx;    char tmpch[4] = "";    static char pCont[10024] = "";    //    strcpy(argv,"https://api.weixin.qq.com/cgi-bin/menu/create?access_token=");    GetHost(pUrl, host_addr, host_file, &portnumber);        /*分析网址、端口、文件名等 */    if(DEBUG)        printf("webhost:%s\n", host_addr);    if(DEBUG)        printf("hostfile:%s\n", host_file);    if(DEBUG)        printf("portnumber:%d\n\n", portnumber);    //    if ((host = gethostbyname(host_addr)) == NULL) {        /*取得主机IP地址 */    //        if (DEBUG)    //            fprintf(stderr, "Gethostname error, %s\n", strerror(errno));    //        exit(1);    //    }    if((host = gethostbyname(host_addr)) == NULL)           /*取得主机IP地址 */    {        if(DEBUG)            fprintf(stderr, "Gethostname error, %s\n", strerror(errno));        exit(1);    }    /* 客户程序开始建立 sockfd描述符 */    if((sockfd = socket(AF_INET, SOCK_STREAM, 0)) == -1)           /*建立SOCKET连接 */    {        if(DEBUG)            fprintf(stderr, "Socket Error:%s\a\n", strerror(errno));        exit(1);    }    /* 客户程序填充服务端的资料 */    bzero(&server_addr, sizeof(server_addr));    server_addr.sin_family = AF_INET;    server_addr.sin_port = htons(portnumber);    server_addr.sin_addr = *((struct in_addr *) host->h_addr);    /* 客户程序发起连接请求 */    if(connect(sockfd, (struct sockaddr *)(&server_addr), sizeof(struct sockaddr)) == -1)            /*连接网站 */    {        if(DEBUG)            fprintf(stderr, "Connect Error:%s\a\n", strerror(errno));        exit(1);    }    /* SSL初始化 */    SSL_library_init();    SSL_load_error_strings();    ctx = SSL_CTX_new(SSLv23_client_method());    if(ctx == NULL)    {        ERR_print_errors_fp(stderr);        exit(1);    }    ssl = SSL_new(ctx);    if(ssl == NULL)    {        ERR_print_errors_fp(stderr);        exit(1);    }    /* 把socket和SSL关联 */    ret = SSL_set_fd(ssl, sockfd);    if(ret == 0)    {        ERR_print_errors_fp(stderr);        exit(1);    }    RAND_poll();    while(RAND_status() == 0)    {        unsigned short rand_ret = rand() % 65536;        RAND_seed(&rand_ret, sizeof(rand_ret));    }    ret = SSL_connect(ssl);    if(ret != 1)    {        ERR_print_errors_fp(stderr);        exit(1);    }    //host_file    /*    post格式说明：每行前不可以有空格    POST https://api.weixin.qq.com/cgi-bin/menu/create?access_token=lQEAXOvehXccOPDfSCCX50giI46RlcT2X_OqrhS_sbTkIi0laDx8bfMDGVEKD3IVgQl24PuiP9rXHKvskdTcOoPcRbj-K5NXfRxBSGNUgIaorMl3Z4Jx6WUnnAvAChVorpTh-cViMxiJltMNtC2LNg HTTP/1.1    Accept: *\/*    Accept-Language: zh-cn    User-Agent: Mozilla/4.0 (compatible; MSIE 5.01; Windows NT 5.0)    Content-Type: application/json               //must    Host: api.weixin.qq.com:443    Connection: Keep-Alive    Content-Length: 68                           //must    {"button":[{"type":"click","name":"Wifi Net","key":"ncm_wifi_net"}]}    506 bytes send OK!    The following is the response header:    HTTP/1.1 200 OK    Server: nginx/1.4.4    Date: Thu, 27 Mar 2014 06:16:11 GMT    Content-Type: application/json; encoding=utf-8    Content-Length: 27    Connection: close    {"errcode":0,"errmsg":"ok"}    */    sprintf(request, "POST %s HTTP/1.1\r\nAccept: */*\r\nAccept-Language: UTF-8\r\n\User-Agent: Mozilla/4.0 (compatible; MSIE 5.01; Windows NT 5.0)\r\n\Content-Type: application/json\r\n\Host: %s:%d\r\nConnection: Keep-Alive\r\nContent-Length: %d\r\n\r\n%s\r\n\r\n", pUrl, host_addr,            portnumber, strlen(pPostVar), pPostVar);    if(DEBUG)        printf("%s", request);        /*准备request，将要发送给主机 */    /*发送https请求request */    send = 0;    totalsend = 0;    nbytes = strlen(request);    while(totalsend < nbytes)    {        send = SSL_write(ssl, request + totalsend, nbytes - totalsend);        if(send == -1)        {            if(DEBUG)                ERR_print_errors_fp(stderr);            exit(0);        }        totalsend += send;        if(DEBUG)            printf("%d bytes send OK!\n", totalsend);    }    if(DEBUG)        printf("\nThe following is the response header:\n");    i = 0;    /* 连接成功了，接收https响应，response */    while((nbytes = SSL_read(ssl, buffer, 1)) == 1)    {        if(i < 4)        {            if(buffer[0] == '\r' || buffer[0] == '\n')                i++;            else                i = 0;            if(DEBUG)                printf("%c", buffer[0]);        /*把https头信息打印在屏幕上 */        }        else        {            if(DEBUG)                printf("%c", buffer[0]);            sprintf(tmpch, "%c", buffer[0]);            if(i == 4)            {                strcpy(pCont, tmpch);            }            else            {                strcat(pCont, tmpch);            }            i++;        }    }    /* 结束通讯 */    ret = SSL_shutdown(ssl);    if(ret != 1)    {        ERR_print_errors_fp(stderr);        //        exit(1);    }    close(sockfd);    SSL_free(ssl);    SSL_CTX_free(ctx);    ERR_free_strings();    char caReturn[1024];    pasUtf8ToGBK(pCont, caReturn, 1000);    printf("return=%s\n", caReturn);    return (char *)caReturn;}//post方式获取内容char *getXmlConByPost(char *pUrl, char *pPostVar){    int sockfd, ret;    char buffer[1024];    struct sockaddr_in server_addr;    struct hostent *host;    int portnumber, nbytes;    char host_addr[256];    char host_file[1024];    char local_file[256];    char request[1024]="";    int send, totalsend;    int i;    char *pt;    SSL *ssl;    SSL_CTX *ctx;    char tmpch[4] = "";    static char pCont[10024] = "";	memset(pCont, 0,  sizeof(pCont));    //    strcpy(argv,"https://api.weixin.qq.com/cgi-bin/menu/create?access_token=");    GetHost(pUrl, host_addr, host_file, &portnumber);        /*分析网址、端口、文件名等 */    if(DEBUG)        printf("webhost:%s\n", host_addr);    if(DEBUG)        printf("hostfile:%s\n", host_file);    if(DEBUG)        printf("portnumber:%d\n\n", portnumber);    //    if ((host = gethostbyname(host_addr)) == NULL) {        /*取得主机IP地址 */    //        if (DEBUG)    //            fprintf(stderr, "Gethostname error, %s\n", strerror(errno));    //        exit(1);    //    }    if((host = gethostbyname(host_addr)) == NULL)           /*取得主机IP地址 */    {        if(DEBUG)            fprintf(stderr, "Gethostname error, %s\n", strerror(errno));        exit(1);    }    /* 客户程序开始建立 sockfd描述符 */    if((sockfd = socket(AF_INET, SOCK_STREAM, 0)) == -1)           /*建立SOCKET连接 */    {        if(DEBUG)            fprintf(stderr, "Socket Error:%s\a\n", strerror(errno));        exit(1);    }    /* 客户程序填充服务端的资料 */    bzero(&server_addr, sizeof(server_addr));    server_addr.sin_family = AF_INET;    server_addr.sin_port = htons(portnumber);    server_addr.sin_addr = *((struct in_addr *) host->h_addr);    /* 客户程序发起连接请求 */    if(connect(sockfd, (struct sockaddr *)(&server_addr), sizeof(struct sockaddr)) == -1)            /*连接网站 */    {        if(DEBUG)            fprintf(stderr, "Connect Error:%s\a\n", strerror(errno));        exit(1);    }    /* SSL初始化 */    SSL_library_init();    SSL_load_error_strings();    ctx = SSL_CTX_new(SSLv23_client_method());    if(ctx == NULL)    {        ERR_print_errors_fp(stderr);        exit(1);    }    ssl = SSL_new(ctx);    if(ssl == NULL)    {        ERR_print_errors_fp(stderr);        exit(1);    }    /* 把socket和SSL关联 */    ret = SSL_set_fd(ssl, sockfd);    if(ret == 0)    {        ERR_print_errors_fp(stderr);        exit(1);    }    RAND_poll();    while(RAND_status() == 0)    {        unsigned short rand_ret = rand() % 65536;        RAND_seed(&rand_ret, sizeof(rand_ret));    }    ret = SSL_connect(ssl);    if(ret != 1)    {        ERR_print_errors_fp(stderr);        exit(1);    }    //host_file    /*    post格式说明：每行前不可以有空格    POST https://api.weixin.qq.com/cgi-bin/menu/create?access_token=lQEAXOvehXccOPDfSCCX50giI46RlcT2X_OqrhS_sbTkIi0laDx8bfMDGVEKD3IVgQl24PuiP9rXHKvskdTcOoPcRbj-K5NXfRxBSGNUgIaorMl3Z4Jx6WUnnAvAChVorpTh-cViMxiJltMNtC2LNg HTTP/1.1    Accept: *\/*    Accept-Language: zh-cn    User-Agent: Mozilla/4.0 (compatible; MSIE 5.01; Windows NT 5.0)    Content-Type: application/json               //must    Host: api.weixin.qq.com:443    Connection: Keep-Alive    Content-Length: 68                           //must    {"button":[{"type":"click","name":"Wifi Net","key":"ncm_wifi_net"}]}    506 bytes send OK!    The following is the response header:    HTTP/1.1 200 OK    Server: nginx/1.4.4    Date: Thu, 27 Mar 2014 06:16:11 GMT    Content-Type: application/json; encoding=utf-8    Content-Length: 27    Connection: close    {"errcode":0,"errmsg":"ok"}    */			sprintf(request, "POST %s HTTP/1.1\r\nAccept: */*\r\nAccept-Language: UTF-8\r\n\		User-Agent: Mozilla/4.0 (compatible; MSIE 5.01; Windows NT 5.0)\r\n\Content-Type: application/json\r\n\		Host: %s:%d\r\nConnection: Keep-Alive\r\nContent-Length: %d\r\n\r\n%s\r\n\r\n", pUrl, host_addr,					portnumber, strlen(pPostVar), pPostVar);    if(DEBUG)        printf("%s", request);        /*准备request，将要发送给主机 */    /*发送https请求request */    send = 0;    totalsend = 0;    nbytes = strlen(request);    while(totalsend < nbytes)    {        send = SSL_write(ssl, request + totalsend, nbytes - totalsend);        if(send == -1)        {            if(DEBUG)                ERR_print_errors_fp(stderr);            exit(0);        }        totalsend += send;        if(DEBUG)            printf("%d bytes send OK!\n", totalsend);    }    if(DEBUG)        printf("\nThe following is the response header:\n");    i = 0;    /* 连接成功了，接收https响应，response */    while((nbytes = SSL_read(ssl, buffer, 1)) == 1)    {        if(i < 4)        {            if(buffer[0] == '\r' || buffer[0] == '\n')                i++;            else                i = 0;            if(DEBUG)                printf("%c", buffer[0]);        /*把https头信息打印在屏幕上 */        }        else        {            if(DEBUG)                printf("%c", buffer[0]);            sprintf(tmpch, "%c", buffer[0]);            if(i == 4)            {                strcpy(pCont, tmpch);            }            else            {                strcat(pCont, tmpch);            }            i++;        }    }    /* 结束通讯 */    ret = SSL_shutdown(ssl);    if(ret != 1)    {        ERR_print_errors_fp(stderr);        //        exit(1);    }    close(sockfd);    SSL_free(ssl);    SSL_CTX_free(ctx);    ERR_free_strings();    static char caReturn[1024];    pasUtf8ToGBK(pCont, caReturn, 1000);    printf("return=%s\n", caReturn);    return (char *)caReturn;}int removeCData(char* originStr, char* newStr, ulong maxLenth){    char cDataLeft[16] = "<![CDATA[";    char cDataRight[16] = "]]>";    ncUtlGetWordBetween(originStr, cDataLeft, cDataRight, newStr, maxLenth);    return 0;}int getNodeValue(char* outXml, char* startStr, char* endStr, char* outStr, ulong maxLength){    char caTemp[128] = "";    ncUtlGetWordBetween(outXml, startStr, endStr, caTemp, 128);    removeCData(caTemp, outStr,  maxLength);    return 0;}int letUserLogin(utShmHead *psShmHead, int iFd, utMsgHead *psMsgHead, ncPortalOnline* psOnline, uint4 lGroupid, char* caName, char* caUserIp, char* caPass, char* caTsid){    char caUserMac[64] = "";    char caPlate[128] = "";    ncPortalStype* psStype = NULL;    char *pPlate = NULL;    ncPortalUser * psUser = NULL;    int iStatus = 5;    int iReturn = 0, iRet = 0, iCode = 0;    int iEnd = 0;    ncPortalAcInfo  *psAc = NULL;    uchar caAcName[28] = "";    char caChallenge[32] = "";    uint2 nReqId = 0;    char caChapPass[32] = "";    char caUserType[16] = "";    char caNasid[24] = "";    char caMsg[4096] = "";    char caSsid[32] = "";    char caSrvIp[32] = "", caSrvPort[10] = "";    char caLang[16] = "";    char caUrl[256] = "";    char caTerm[16], caOs[16], caBro[16], caType[16];    char caGwid[32] = "", caGwip[32] = "", caGwport[8] = "";    char caUserAgent[256] = "";    char caPostUrl[256] = "";    long long lSid = 0;    utPltDbHead *psDbHead;    psDbHead = utPltInitDbHead();    // 检查黑名单    iEnd = 0;    if(psOnline)    {        lGroupid = psOnline->lStype;        pasLogs(PAS_SRCFILE, 1008, "psOnline Stype=%u", lGroupid);    }    if(psOnline)    {        strcpy(caUserMac, pasCvtMac(psOnline->caMac));        psStype = (ncPortalStype *)ncSrvGetStypeById(psShmHead, lGroupid);        psUser = (ncPortalUser *)ncSrvGetUserByName(psShmHead, caName, lGroupid);        iReturn = 9;        if(psUser)        {            pasLogs(PAS_SRCFILE, 1008, "ncSrvGetUserByName UserStatus=%d ExcessMac=%d SumMac=%d MaxMac=%d",                    psUser->cStatus, psUser->psPar->cExceedMac, psUser->cSum, psUser->cMaxMac);            if(psUser->cStatus != 0)            {                iStatus = NCSRV_STATUSCODE_EXPIRE;            }            if(psUser->psPar && ncSrvIsTimeFlowCtl())            {                if(psUser->psPar->lLimittime > 0 && psUser->lSumConnTime > psUser->psPar->lLimittime)    // 超出每天上网时间                {                    iStatus = NCSRV_STATUSCODE_EXCEEDTIME;                    iEnd = 1;                    iReturn = 1;                }                if(psUser->psPar->limitflow > 0 && psUser->lSumBytes / 1024 > psUser->psPar->limitflow)    // 超出每天上网流量                {                    iStatus = NCSRV_STATUSCODE_EXCEEDFLOW;                    iEnd = 1;                    iReturn = 1;                }                if(psUser->psPar->limitlogin > 0 && psUser->lSumLogin >= psUser->psPar->limitlogin)    // 超出每天上网流量                {                    iStatus = NCSRV_STATUSCODE_EXCEEDLOGIN;                    iEnd = 1;                    iReturn = 1;                }            }        }        else        {            iStatus = NCSRV_STATUSCODE_NOEXIST;            iEnd = 1;            pasLogs(PAS_SRCFILE, 1008, "User %s no exist Stype=%u", caName, lGroupid);        }        psAc = NULL;        if(!iEnd)        {            if(ncSrvPortalIsBlackUser(psShmHead, psOnline->lStype, NCPORTAL_BLACK_USER, caName))            {                iEnd = 1;                iReturn = 1;                iStatus = NCSRV_STATUSCODE_BLACKLIST;                pasLogs(PAS_SRCFILE, 1008, " User %s is in black list ", caName);            }            else            {                if(psUser && psOnline->psPar && !psOnline->psPar->cSsidRoam && psUser && !utStrIsSpaces(psUser->caSsid) && !utStrIsSpaces(psOnline->caSsid) && strcasecmp(psUser->caSsid, psOnline->caSsid) != 0)                {                    iEnd = 1;                    iReturn = 1;                    iStatus = NCSRV_STATUSCODE_FORBITLOGIN;                    pasLogs(PAS_SRCFILE, 1008, " User %s  Ssid is %s and NoIs  %s", caName, psUser->caSsid, psOnline->caSsid);                }            }        }        if(!iEnd)        {            if(psUser && !ncSrvCheckUserMacIsBind(psShmHead, psUser, psOnline->caMac))            {                if(psUser->cMaxMac > 0 && psUser->cSum >= psUser->cMaxMac && psUser->psPar->cExceedMac == 1)  // 超出绑定数                {                    int iSum;                    psUser->cSum = ncSrvCountMacBindByName(psShmHead, psUser->lStype, caName);                    if(psUser->cSum >= psUser->cMaxMac)                    {                        iEnd = 1;                        iReturn = 1;                        iStatus = NCSRV_STATUSCODE_EXCEEDMAC;                        pasLogs(PAS_SRCFILE, 1008, " User %s  Mac Bind  %d Exceed MacMac %d, Forbit", caName, psUser->cSum, psUser->cMaxMac);                    }                }            }            else            {                pasLogs(PAS_SRCFILE, 1008, " User %s  Mac %s Already Bind ", caName, pasCvtMac(psOnline->caMac));            }        }        if(iEnd != 1)        {            strcpy(caAcName, psOnline->caAcName);            psAc = (ncPortalAcInfo *)ncSrvGetAcInfo(psShmHead, caAcName);        }        if(psAc)        {            // iStatus = 5;            if(strcasecmp(psAc->caAcType, "Ac") == 0)            {                lReqIdNum = psAc->nSn;                psAc->nSn++;                if(iPapChap == 0)                {                    iReturn = ncSrvSendToAcRequestChallenge(psAc->lAcip, psAc->nAcPort, lReqIdNum, caUserIp, &nReqId, caChallenge);                    pasLogsHex(PAS_SRCFILE, 1009, caChallenge, 16, "[ncSrvSendToAcRequestChallenge1]");                    if(iReturn == 0)                    {                        iReturn = ncSrvSendToAcRequesChapAuth(psAc->lAcip, psAc->nAcPort, lReqIdNum, nReqId, caUserIp, caName, caChallenge, caPass, caChapPass);                    }                }                else                {                    iReturn = ncSrvSendToAcRequesPapAuth(psAc->lAcip, psAc->nAcPort, lReqIdNum, 0, caUserIp, caName, caPass);                }                pasLogs(PAS_SRCFILE, 1008, " ACAuth Name:%s   Ip:%s    iRet=%d ", caName, caUserIp, iReturn);                iEnd = 1;            }            else if(strcasecmp(psAc->caAcType, "ProEIM") == 0)            {                if(strcasecmp(caUserType, "shgmvip") == 0)                {                    iReturn = ncSrvLoginByShGm(psShmHead, psStype ? psStype->ucode : "\0", caSsid, psAc->lAcip, psAc->nAcPort, caNasid, caUserIp, caUserMac, caName, caPass);                    pasLogs(PAS_SRCFILE, 1008, " Name:%s  Pass:%s  Ip:%s    iRet=%d ", caName, caPass, caUserIp, iReturn);                    iEnd = 1;                }                else                {                    iReturn = ncSrvLoginByProEIM(psShmHead, psOnline ? psOnline->lStype : 0, psAc->lAcip, psAc->nAcPort, caNasid, caUserIp, caUserMac, caName, caPass);                    pasLogs(PAS_SRCFILE, 1008, " Name:%s   Ip:%s    iRet=%d ", caName, caUserIp, iReturn);                    iEnd = 1;                }            }            else if(strncasecmp(psAc->caAcType, "Meru", 4) == 0)            {                char caUsername1[64];                char *p;                p = strstr(psAc->caDomain, "@");                if(p)                {                    if(psAc->caDomain[0] == '@')                    {                        sprintf(caUsername1, "%s%s", caName, psAc->caDomain);                    }                    else                    {                        sprintf(caUsername1, "%s%s", psAc->caDomain, caName);                    }                }                else                {                    strcpy(caUsername1, caName);                }                iReturn = ncSrvUserAuth_MeruHttps(psAc->caPost, caUsername1, caPass, caUserMac, caUserIp, caMsg);                pasLogs(PAS_SRCFILE, 1008, "[ncSrvUserAuth_MeruHttps] Name:%s  Pass:%s  UsreMac:%s  Ip:%s iRet=%d  Mesg=%s", caUsername1, caPass, caUserMac, caUserIp, iReturn, caMsg);                iEnd = 1;            }            else if(strcasecmp(psAc->caAcType, "Radius") == 0)            {                char caUsername1[64];                char *p;                psOnline->lAcIp = psAc->lAcip;                psOnline->nAcPort = psAc->nAcPort;                strcpy(psOnline->caKey, psAc->caKey);                psOnline->cAuthType = psAc->iAuthType;                p = strstr(psAc->caDomain, "@");                if(p)                {                    if(psAc->caDomain[0] == '@')                    {                        sprintf(caUsername1, "%s%s", caName, psAc->caDomain);                    }                    else                    {                        sprintf(caUsername1, "%s%s", psAc->caDomain, caName);                    }                }                else                {                    strcpy(caUsername1, caName);                }                iReturn = ncSrvLogin_AuthMeru(psShmHead, psOnline, caUserIp, caUsername1, caPass);                pasLogs(PAS_SRCFILE, 1008, " Radius Name:%s   Ip:%s    iRet=%d ", caUsername1, caUserIp, iReturn);                if(iReturn == 2)                {                    if(psOnline->cFrom == NCPORTAL_VENDOR_MERU)                    {                        iRet = ncSrvMeruSshDoLogin(psShmHead, caUserIp, 5, psOnline->caAcName);                        strcpy(psOnline->caName, caName);                        psUser = (ncPortalUser *)ncSrvSynUserPassword(psShmHead, psOnline->lStype, psOnline->lGroupid, caName, caPass, "\0", psOnline->caSsid, NCSRV_USERTYPE_SMS);                        if(psUser)                        {                            psOnline->psUser = psUser;                        }                        iStatus = 0;                        pasLogs(PAS_SRCFILE, 1008, " Radius ncSrvMeruSshDoLogin: Ip:%s AcName=%s iRet=%d ", caUserIp, psOnline->caAcName, iRet);                    }                    else if(psOnline->cFrom == NCPORTAL_VENDOR_PROEIMV7)                    {                        strcpy(psOnline->caName, caName);                        psUser = (ncPortalUser *)ncSrvSynUserPassword(psShmHead, psOnline->lStype, psOnline->lGroupid, caName, caPass, "\0", psOnline->caSsid, NCSRV_USERTYPE_SMS);                        if(psUser)                        {                            psOnline->psUser = psUser;                        }                        iStatus = 0;                        pasLogs(PAS_SRCFILE, 1008, " Radius ncSrvDoLogin_ProEIMV7: Ip:%s AcName=%s iRet=%d ", caUserIp, psOnline->caAcName, iRet);                        iEnd = 1;                    }                }                else                {                    iStatus = iReturn;                }                iEnd = 1;            }            else if(strcasecmp(psAc->caAcType, "CenAuth") == 0)            {                psOnline->lAcIp = psAc->lAcip;                psOnline->nAcPort = psAc->nAcPort;                strcpy(psOnline->caKey, psAc->caKey);                psOnline->cAuthType = psAc->iAuthType;                iReturn = ncSrvLogin_AuthCenter(psShmHead, psOnline, caUserIp, caName, caPass);                if(iReturn == 2)                {                    strcpy(psOnline->caName, caName);                    psUser = (ncPortalUser *)ncSrvSynUserPassword(psShmHead, psOnline->lStype, psOnline->lGroupid, caName, caPass, "\0", psOnline->caSsid, NCSRV_USERTYPE_SMS);                    if(psUser)                    {                        psOnline->psUser = psUser;                    }                    ncSrvUpdateOnlineUserByOnline(psShmHead, psOnline, caName, caName);                    iStatus = 0;                }                else                {                    iStatus = iReturn;                }                pasLogs(PAS_SRCFILE, 1008, " CenterAuth Name:%s   Ip:%s    iRet=%d ", caName, caUserIp, iReturn);                iEnd = 1;            }        }        if(iEnd == 0)        {            if(psOnline->cFrom == NCPORTAL_VENDOR_GBAP || psOnline->cFrom == NCPORTAL_VENDOR_WIFIDOG || psOnline->cFrom == NCPORTAL_VENDOR_BCTH || psOnline->cFrom == NCPORTAL_VENDOR_PROEIMV7)            {                iReturn = ncSrvLoginByLocal(psShmHead, psOnline->lStype, 0, 0, caUserIp, caUserMac, caName, caPass);                if(iReturn == 2 || iReturn == 0)                {                    ncSrvUpdateOnlineUserByOnline(psShmHead, psOnline, caName, caName);                }                pasLogs(PAS_SRCFILE, 1008, "【ncSrvLoginByLocal】 Name:%s   Ip:%s    iRet=%d From:%d ", caName, caUserIp, iReturn, psOnline->cFrom);                iEnd = 1;            }        }        if(iReturn == 0 || iReturn == 2)  // 认证成功        {            if(pasLogsIsOut(PAS_SRCFILE, 1088, NULL))            {                printf(" Pid==%d\n", getpid());                sleep(10);            }            psOnline->cAuthWay = NCPORTAL_LOGIN_WEBAUTH;            iStatus = 0;            utPltPutVar(psDbHead, "lang",    caLang);            sprintf(caMsg, "tsid@%s&wlanacname@%s&userip@%s&ssid@%s&usermac@%s&username@%s", caTsid, caAcName, caUserIp, caSsid, caUserMac, caName);            utPltPutVar(psDbHead, "getarg", caMsg);            utPltPutVar(psDbHead, "ip",    caSrvIp);            utPltPutVar(psDbHead, "port",  caSrvPort);            utPltPutVar(psDbHead, "userip", caUserIp);            utPltPutVar(psDbHead, "usermac", caUserMac);            utPltPutVar(psDbHead, "username", caName);            utPltPutVar(psDbHead, "tsid", caTsid);            utPltPutVar(psDbHead, "wlanacname",  caAcName);            utPltPutVar(psDbHead, "statusCode", "0");            strcpy(caMsg, "\0");            utStrAddF(caMsg, "<input type=\"hidden\" name=\"%s\" value=\"%s\">", "FunName", "ncSrvLogin");            utStrAddF(caMsg, "<input type=\"hidden\" name=\"%s\" value=\"%s\">", "lang", caLang);            utStrAddF(caMsg, "<input type=\"hidden\" name=\"%s\" value=\"%s\">", "userip", caUserIp);            utStrAddF(caMsg, "<input type=\"hidden\" name=\"%s\" value=\"%s\">", "usermac", caUserMac);            utStrAddF(caMsg, "<input type=\"hidden\" name=\"%s\" value=\"%s\">", "ssid", caSsid);            utStrAddF(caMsg, "<input type=\"hidden\" name=\"%s\" value=\"%s\">", "tsid", caTsid);            utStrAddF(caMsg, "<input type=\"hidden\" name=\"%s\" value=\"%s\">", "wlanacname", caAcName);            utPltPutVar(psDbHead, "postarg", caMsg);            if(psAc && strcasecmp(psAc->caAcType, "Ac") == 0)            {                iReturn = ncSrvSendToAcAuthAck(psAc->lAcip, psAc->nAcPort, lReqIdNum, nReqId, caUserIp);            }            else if(psOnline->cFrom == NCPORTAL_VENDOR_GBAP)            {                char caHost[64], caUrl1[512];                // http://115.29.172.248/cmps/admin.php/api/quicklogin1?gw_address=192.168.20.1&gw_port=8060&gw_id=hotspot2&ip=192.168.20.133&mac=1C:4B:D6:8F:BE:4A&url=http%3A//www.baidu.com/                //                sprintf(caHost,"%s:%u",utComHostIp(htonl(psAc->lAcip)),psAc->nAcPort);                sprintf(caHost, "%s:%u", "www.login-wifi.com", psAc->nAcPort);                sprintf(caUrl1, "http://%s/cmps/admin.php/api/quicklogin1?gw_address=%s&gw_port=%s&gw_id=%s&ip=%s&mac=%s&url=%s",                        caHost, caGwip, caGwport, caGwid, caUserIp, caUserMac, caUrl);                utPltPutVar(psDbHead, "reurl", caUrl1);                pasLogs(PAS_SRCFILE, 1008, "【GBAPl】 Return=%d Plate:%s",                        iReturn, "nc/portalredir.htm");                if(iReturn == 2)                {                    utPltOutToHtml(iFd, psMsgHead, psDbHead, "nc/portalredir.htm");                    return 0;                }                //                    ncSrvSendAck2Gbcom(caHost,caUrl1);            }            else if(psOnline->cFrom == NCPORTAL_VENDOR_WIFIDOG || psOnline->cFrom == NCPORTAL_VENDOR_BCTH)            {                char caToken[48];                if(psOnline)                {                    sprintf(caToken, "%llu", psOnline->lTsid);                    psOnline->cAuthWay = NCPORTAL_LOGIN_WEBAUTH;                }                if(psOnline->psPar && psOnline->psPar->cWeixinAuth == 1 && !utStrIsSpaces(psOnline->caOpenid))                {                    if(psOnline->psUser)    //  绑定                    {                        if(strcmp(psOnline->psUser->caOpenId, psOnline->caOpenid) != 0)                        {                            strcpy(psOnline->psUser->caOpenId, psOnline->caOpenid);                            pasLogs(PAS_SRCFILE, 1008, "【WIFIDOG】 Bind Weixin %s", psOnline->caOpenid);                            psOnline->psUser->cMod = 1;                        }                    }                }                pasLogs(PAS_SRCFILE, 1008, "【WIFIDOG】 Return=%d Token:%s", iReturn, caToken);                ncSrvGBAuthRedir(psShmHead, iFd, psMsgHead, caToken, psOnline->cFrom);                utPltFreeDb(psDbHead);                return 0;            }            else if(psOnline->cFrom == NCPORTAL_VENDOR_PROEIMV7)            {                char caUrl1[512];                char caUserIp[32];                char caTemp[512];                char caApMac[64], caSsid[64];                char caRssi[16];                ncLbsMacLocation *psMac;                strcpy(caUserIp, utComHostIp(htonl(psOnline->lSip)));                strcpy(caUserMac, pasStrEncodeDesHex(pasCvtMac(psOnline->caMac), caTemp, PAS_DEF_KEY));                strcpy(caName, pasStrEncodeDesHex(psOnline->caName, caTemp, PAS_DEF_KEY));                strcpy(caApMac, pasStrEncodeDesHex(psOnline->caApName, caTemp, PAS_DEF_KEY));                strcpy(caSsid, pasStrEncodeDesHex(psOnline->caSsid, caTemp, PAS_DEF_KEY));                if(strcmp(caSrvPort, "443") == 0)                {                    sprintf(caUrl, "https://%s:%s/pronline/Msg?FunName=ncSrvLoginOK&tsid=%s", caSrvIp, caSrvPort, caTsid);                }                else                {                    sprintf(caUrl, "http://%s:%s/pronline/Msg?FunName=ncSrvLoginOK&tsid=%s", caSrvIp, caSrvPort, caTsid);                }                pasStrEncodeDesHex(caUrl, caTemp, PAS_DEF_KEY);                sprintf(caUrl1, "http://%s:%u/proauth/Msg?FunName@ncWebPortalDoLogin&username=%s&userip=%s&mac=%s&apmac=%s&ssid=%s&url=%s",                        utComHostIp(htonl(psOnline->lGwip)),                        psOnline->nGwport,                        caName,                        caUserIp,                        caUserMac,                        caApMac,                        caSsid,                        caTemp);                psMac = (ncLbsMacLocation *)ncSrvGetMacLogByMac(psShmHead, psOnline->caMac);                if(psMac)                {                    utStrAddF(caUrl1, "&rssi=%d", psMac->urssi);                }                if(!utStrIsSpaces(psOnline->caOpenid))                {                    utStrAddF(caUrl1, "&openid=%s", psOnline->caOpenid);                }                pasSetHttpHeadStatus(302, "Found");                pasSetHttpHeadLocation(caUrl1);                pasLogs(PAS_SRCFILE, 1008, "User:%s  Red:%s ", psOnline->caName, caUrl1);                ncSrvUpdateOnlineUserByOnline(psShmHead, psOnline, psOnline->caName, psOnline->caName);                utPltOutToHtmlFromBuf(iFd, psMsgHead, psDbHead, "\0");                return 0;            }            caTerm[0] = 0;            caOs[0] = 0;            caBro[0] = 0;            caType[0] = 0;            iRet = pasUtlTermAttr(caUserAgent, caTerm, caOs, caBro, caType);            pasLogs(PAS_SRCFILE, 1009, "[%d %-8s %-8s %-8s %-8s ]%s\n", iRet, caType, caTerm, caOs, caBro, caUserAgent);            pPlate = ncSrvGetPlateInfo(psShmHead, ncSrvGetPlateName(psShmHead, psOnline), caType, caLang, &iCode);            if(pPlate)            {                sprintf(caPlate, "%s/login_ok.htm", pPlate);            }            else            {                sprintf(caPlate, "default/login_ok.htm");            }            if(strcmp(caSrvPort, "443") == 0)            {                sprintf(caPostUrl, "https://%s:%s/pronline/Msg", caSrvIp, caSrvPort);            }            else            {                sprintf(caPostUrl, "http://%s:%s/pronline/Msg", caSrvIp, caSrvPort);            }            if(psOnline)            {                iReturn = ncSrvUpdateOnlineUserByOnline(psShmHead, psOnline, caName, "\0");                psOnline->login = NCPORTAL_ONLINE_LOGIN;                psOnline->logintime = time(0);                psOnline->lasttime = time(0);                psOnline->cAuthWay = NCPORTAL_LOGIN_WEBAUTH;                pasLogs(PAS_SRCFILE, 1009, "ncSrvUpdateOnlineUserByOnline Name:%s iReturn=%d\n", caName, iReturn);            }            utPltPutVar(psDbHead, "posturl", caPostUrl);            pasLogs(PAS_SRCFILE, 1009, "Plate=%s\n", caPlate);            pasUtlOut2DbFile("ncsrvloginlog", 15,                             "sid",       UT_TYPE_LONG8,  lSid,                            // 自动增加                             "servicecode", UT_TYPE_STRING, caServicecode,                             "did",        UT_TYPE_ULONG, 0,                             "gid",        UT_TYPE_ULONG, 0,                             "userid",     UT_TYPE_ULONG,  0,                               //                             "username",   UT_TYPE_STRING, caName,                             "usermac",    UT_TYPE_STRING, caUserMac,                             "ip",         UT_TYPE_STRING, caUserIp,                             "logtime",    UT_TYPE_ULONG,  time(0),                             "platename",  UT_TYPE_STRING, caPlate,                             "fun",        UT_TYPE_STRING, "login",                             "dev",        UT_TYPE_STRING, caTerm,                             "os",         UT_TYPE_STRING, caOs,                             "devtype",    UT_TYPE_STRING, caType,                             "status",     UT_TYPE_ULONG,   1);            utPltOutToHtml(iFd, psMsgHead, psDbHead, caPlate);        }        else    // 认证失败        {            char caFile9[128];            sprintf(caMsg, "tsid@%s&wlanacname@%s&wlanuserip@%s&ssid@%s&usermac@%s&username@%s", caTsid, caAcName, caUserIp, caSsid, caUserMac, caName);            utPltPutVar(psDbHead, "getarg", caMsg);            strcpy(caMsg, "\0");            utStrAddF(caMsg, "<input type=\"hidden\" name=\"%s\" value=\"%s\">", "FunName", "ncSrvLogin");            utStrAddF(caMsg, "<input type=\"hidden\" name=\"%s\" value=\"%s\">", "lang", caLang);            utStrAddF(caMsg, "<input type=\"hidden\" name=\"%s\" value=\"%s\">", "userip", caUserIp);            utStrAddF(caMsg, "<input type=\"hidden\" name=\"%s\" value=\"%s\">", "usermac", caUserMac);            utStrAddF(caMsg, "<input type=\"hidden\" name=\"%s\" value=\"%s\">", "ssid", caSsid);            utStrAddF(caMsg, "<input type=\"hidden\" name=\"%s\" value=\"%s\">", "tsid", caTsid);            if(!utStrIsSpaces(caAcName))                utStrAddF(caMsg, "<input type=\"hidden\" name=\"%s\" value=\"%s\">", "wlanacname", caAcName);            utPltPutVar(psDbHead, "postarg", caMsg);            utPltPutVar(psDbHead, "lang",  caLang);            utPltPutVar(psDbHead, "tsid",  caTsid);            utPltPutVar(psDbHead, "ip",    caSrvIp);            utPltPutVar(psDbHead, "port",  caSrvPort);            utPltPutVar(psDbHead, "userip", caUserIp);            utPltPutVar(psDbHead, "usermac", caUserMac);            utPltPutVar(psDbHead, "username", caName);            utPltPutVar(psDbHead, "wlanacname",  caAcName);            utPltPutVarF(psDbHead, "statusCode", "%d", iStatus);            iRet = pasUtlTermAttr(caUserAgent, caTerm, caOs, caBro, caType);            pasLogs(PAS_SRCFILE, 1009, "[%d %-8s %-8s %-8s %-8s ]%s\n", iRet, caType, caTerm, caOs, caBro, caUserAgent);            pPlate = ncSrvGetPlateInfo(psShmHead, ncSrvGetPlateName(psShmHead, psOnline), caType, caLang, &iCode);            if(pPlate)            {                sprintf(caPlate, "%s/login_error.htm", pPlate);                sprintf(caFile9, "%s/%s", utPltGetPlatePath(), caPlate);                if(!utFileIsExist(caFile9))                {                    sprintf(caPlate, "%s/login_main.htm", pPlate);                }            }            else            {                sprintf(caPlate, "default/login_error.htm", pPlate);                sprintf(caFile9, "%s/%s", utPltGetPlatePath(), caPlate);                if(!utFileIsExist(caFile9))                {                    sprintf(caPlate, "default/login_main.htm", pPlate);                }            }            if(strcasecmp(caLang, "zh") == 0)            {                char caTemp[256];                sprintf(caTemp, "您输入的账号或密码不正确");                pasCharsetCvt(PAS_CCODE_GB, iCode, caTemp, caMsg, 255);            }            else            {                sprintf(caMsg, "User name or password Error");            }            if(strcmp(caSrvPort, "443") == 0)            {                sprintf(caPostUrl, "https://%s:%s/pronline/Msg", caSrvIp, caSrvPort);            }            else            {                sprintf(caPostUrl, "http://%s:%s/pronline/Msg", caSrvIp, caSrvPort);            }            utPltPutVar(psDbHead, "posturl", caPostUrl);            utPltPutVar(psDbHead, "message", caMsg);            pasLogs(PAS_SRCFILE, 1009, "Plate=%s Message=%s\n", caPlate, caMsg);            pasUtlOut2DbFile("ncsrvloginlog", 15,                             "sid",       UT_TYPE_LONG8,  lSid,                            // 自动增加                             "servicecode", UT_TYPE_STRING, caServicecode,                             "did",        UT_TYPE_ULONG, 0,                             "gid",        UT_TYPE_ULONG, 0,                             "userid",     UT_TYPE_ULONG,  0,                               //                             "username",   UT_TYPE_STRING, caName,                             "usermac",    UT_TYPE_STRING, caUserMac,                             "ip",         UT_TYPE_STRING, caUserIp,                             "logtime",    UT_TYPE_ULONG,  time(0),                             "platename",  UT_TYPE_STRING, caPlate,                             "fun",        UT_TYPE_STRING, "login",                             "dev",        UT_TYPE_STRING, caTerm,                             "os",         UT_TYPE_STRING, caOs,                             "devtype",    UT_TYPE_STRING, caType,                             "status",     UT_TYPE_ULONG,   0);            utPltOutToHtml(iFd, psMsgHead, psDbHead, caPlate);        }    }}