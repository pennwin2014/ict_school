#define  PAS_SRCFILE      3333#include <stdio.h>#include <stdlib.h>#include <string.h>#include <sys/stat.h>#include <string.h>#include <locale.h>#include <unistd.h>#include <sys/types.h>#include <sys/socket.h>#include <netinet/in.h>#include <arpa/inet.h>#include <netdb.h>#include <sys/time.h>#include "utoall.h"#include "utoplt01.h"#include "pasdb.h"#include "ncportal.h"#include <iconv.h>#include "ict_hjj_tool.h"#define SERVICE_INFO 1//显示常见问题int ictm_show_common_questions(utShmHead * psShmHead, int iFd, utMsgHead * psMsgHead){	#if SERVICE_INFO    	utMsgPrintMsg(psMsgHead);	#endif	unsigned long lQuestionId =0;//问题id   	char caQuestionTitle[64] ={0};//问题标题   	char caQuestionContent[256] ={0};//问题内容   	char caUrlQuestionTitle[256] = {0}; //问题标题URL    char caUrlQuestionContent[1024] = {0}; //问题内容URL    uint8 u8Timeval = 0;//问题添加时间    char caCuser[32] ={0};//管理员    char caMark[128]={0};//mark    char caKeyword[32]={0};//搜索的关键词    int iReturn = 0;    char caMsg[256] = {0};	char caTsid[24] = {0};	char sql[1024] = {0};	int db_count = 0; //获取数据的条数	int iret = -1;    int iNum = 0;	char start_in[8] = {0};    char limit_in[8] = {0};    utMsgGetSomeNVar(psMsgHead, 3,    				 "start",    UT_TYPE_STRING,  sizeof(start_in) - 1,    start_in,                     "limit",     UT_TYPE_STRING,      sizeof(limit_in) - 1,    limit_in,                     "keyword",      UT_TYPE_STRING,      sizeof(caKeyword) - 1, caKeyword);        pasDbCursor *psCur = NULL;    utPltDbHead *psDbHead = utPltInitDb();	//处理前台不上传start，limit的情况，设置默认值,现在的模式，limit一般是自动设置	if(strlen(start_in) == 0)	{		snprintf(start_in, sizeof(start_in) - 1, "0");	}	if(strlen(limit_in) == 0)	{		snprintf(limit_in, sizeof(limit_in) - 1, "10");	}    //snprintf(sql, sizeof(sql) - 1, "select id, questionTitle,questionContent,timeval,cuser,mark from tCommonQuestion limit %u,%u",atoi(start_in), atoi(limit_in));	if(strlen(caKeyword)>0){		snprintf(sql, sizeof(sql) - 1, "select id, questionTitle,questionContent,timeval,cuser,mark from tCommonQuestion where questionTitle like '%%%s%%' or questionContent like '%%%s%%' or cuser like '%%%s%%'  ",caKeyword,caKeyword,caKeyword);	}	else	{		snprintf(sql, sizeof(sql) - 1, "select id, questionTitle,questionContent,timeval,cuser,mark from tCommonQuestion");	}	//将limit加到sql中	snprintf(sql+strlen(sql), sizeof(sql)-strlen(sql), " limit %u,%u",atoi(start_in), atoi(limit_in));	printf("sql===========================================%s\n",sql);    psCur = pasDbOpenSql(sql, 0);    if(psCur != NULL)    {        while(0 == (iret = pasDbFetchInto(psCur,										  UT_TYPE_ULONG,sizeof(lQuestionId),&lQuestionId,                                          UT_TYPE_STRING, sizeof(caQuestionTitle) - 1, caQuestionTitle,                                          UT_TYPE_STRING, sizeof(caQuestionContent) - 1, caQuestionContent,                                          UT_TYPE_ULONG, 8, &u8Timeval,                                          UT_TYPE_STRING, sizeof(caCuser) - 1, caCuser,                                          UT_TYPE_STRING, sizeof(caMark) - 1, caMark)) || 1405 == iret)        {            iNum++;            if(iNum > 1)            {                utPltPutLoopVar(psDbHead, "dh", iNum, ",");            }			utPltPutLoopVarF(psDbHead, "qustionId", iNum, "%lu", lQuestionId);			//url编码转换			urlencode(caQuestionTitle, sizeof(caQuestionTitle) - 1, caUrlQuestionTitle, sizeof(caUrlQuestionTitle) - 1);            utPltPutLoopVar(psDbHead, "questionTitle", iNum, caUrlQuestionTitle);			//url编码转换			urlencode(caQuestionContent, sizeof(caQuestionContent) - 1, caUrlQuestionContent, sizeof(caUrlQuestionContent) - 1);            utPltPutLoopVar(psDbHead, "questionContent", iNum, caUrlQuestionContent);			utPltPutLoopVar(psDbHead, "timeval", iNum, utTimFormat("%Y-%m-%d  %H:%M:%S", u8Timeval));			utPltPutLoopVar(psDbHead, "cuser", iNum,  caCuser);			utPltPutLoopVar(psDbHead, "mark", iNum,  caMark);			snprintf(caMsg, sizeof(caMsg) - 1, "查询成功!");			utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));            utPltPutVarF(psDbHead, "result", "%d", 0);        }        pasDbCloseCursor(psCur);    }	else	{		snprintf(caMsg, sizeof(caMsg) - 1, "sql语句执行错误!");		utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));		utPltPutVarF(psDbHead, "TotRec", "%lu", iNum);		utPltPutVarF(psDbHead, "result", "%d", 3);//sql语句执行错误		utPltOutToHtml(iFd, psMsgHead, psDbHead, "ict/customService/commonQuestion/show_common_question.htm");		return 1;	}	if(0 == iNum)//如果数据库表中数据为空	{		snprintf(caMsg, sizeof(caMsg) - 1, "数据库表中数据为空");		utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));		utPltPutVarF(psDbHead, "TotRec", "%lu", iNum);		utPltPutVarF(psDbHead, "result", "%d", 4);		utPltOutToHtml(iFd, psMsgHead, psDbHead, "ict/customService/commonQuestion/show_common_question.htm");		return 1;	}    utPltPutVarF(psDbHead, "TotRec", "%lu", iNum);    utPltOutToHtml(iFd, psMsgHead, psDbHead, "ict/customService/commonQuestion/show_common_question.htm");	return 0;}//批量删除常见问题int ictm_delete_common_questions(utShmHead * psShmHead, int iFd, utMsgHead * psMsgHead){	#if SERVICE_INFO    	utMsgPrintMsg(psMsgHead);	#endif	//unsigned long lQuestionId =0;//问题id	char caQuestionId[1024] = {0};//问题id组合字符串类型    int iReturn = 0;    char caMsg[256] = {0};	char sql[1024] = {0};	int iret = -1;    int iNum = 0;    utMsgGetSomeNVar(psMsgHead, 1,    				 "questionId",UT_TYPE_STRING,sizeof(caQuestionId) - 1,caQuestionId);    //pasDbCursor *psCur = NULL;    utPltDbHead *psDbHead = utPltInitDb();	iReturn = pasDbExecSqlF("delete from tCommonQuestion where id in(%s)",caQuestionId);	printf("delete from tCommonQuestion where id in(%s)\n", caQuestionId);    if(iReturn != 0)     {        pasDbRollback(NULL);		snprintf(caMsg, sizeof(caMsg) - 1, "sql语句执行错误,数据库回滚!");		utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));		utPltPutVarF(psDbHead, "result", "%d", 1);//sql语句执行错误		utPltOutToHtml(iFd, psMsgHead, psDbHead, "ict/customService/commonQuestion/delete_common_question.htm");		return 1;    }      else	{		snprintf(caMsg, sizeof(caMsg) - 1, "删除常见问题成功");		utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));		utPltPutVarF(psDbHead, "result", "%d", 0);		utPltOutToHtml(iFd, psMsgHead, psDbHead, "ict/customService/commonQuestion/delete_common_question.htm");    }  	return 0;}/*//显示对应用户的新问题int ict_show_new_question_info(utShmHead * psShmHead, int iFd, utMsgHead * psMsgHead){    utMsgPrintMsg(psMsgHead);    char caUsername[32] = {0};//用户名    char caMobno[24] = {0};//用户绑定的手机号    char caMark[128] = {0}; //产品标示    char caStatus[4] = {0};//互动状态,0为新的问题，1为后续交流    char caProblemid[12] = {0};//新问题的id，用于前台发送到服务器的数据    uint4 u4problemid = 0;//新问题的id    uint4 u4feedbackid = 0;//互动信息的id    char caTimeval[32] = {0}; //操作时间字符串    char caSubject[128] = {0};//新问题标题    char caContent[256] = {0};//新问题或者回复的内容    char caUrlQuestionTitle[256] = {0}; //问题标题URL    char caUrlQuestionContent[1024] = {0}; //问题内容URL    uint8 u8Timeval = 0;//操作时间    char caCuser[32] = {8};//管理员    int iReturn = 0;    char caMsg[256] = {0};    char caTsid[24] = {0};    long letime = time(0);//为获取当前月份对应表名，而设置的变量    char caFeedbackTableName[128] = {0};//当月的用户订购套餐日志表名    char caStemptime[32] = {0};//当月的时间格式(%Y%m)    char begin[24] = "";    char end[24] = "";    char table_name[256] = "";//查询字符串拼接    char sql_tmp[1024] = "";    int iret = -1;    int iNum = 0;    char start_in[8] = {0};    char limit_in[8] = {0};    int ilimit = 10;    ulong lStart = 0, lLimit = 0;    int lCount = 0;    utMsgGetSomeNVar(psMsgHead, 3,                     "tsid", UT_TYPE_STRING, sizeof(caTsid) - 1, caTsid,                     "start", UT_TYPE_STRING, sizeof(start_in) - 1, start_in,                     "limit", UT_TYPE_STRING, sizeof(limit_in) - 1, limit_in                    );    char sql[1024] = "";    pasDbCursor *psCur = NULL;    utPltDbHead *psDbHead = utPltInitDb();    if(checkTsid(psShmHead, psDbHead, psMsgHead, iFd, caTsid, "school/support/show_new_question_info.htm"))    {        return 0;    }    //处理前台不上传start，limit的情况，设置默认值    if(strlen(start_in) > 0)    {        lStart = atol(start_in);    }    if(strlen(limit_in) > 0)    {        ilimit = atoi(limit_in);    }    //获得已存在的联合表名    combine_table_for_feedback(caFeedbackTableName, "feedback_");    //获得当前月份所对应的表名    //snprintf(caStemptime,sizeof(caStemptime)-1,"%s", utTimFormat("%Y%m", letime));    //printf("caStemptime=======================%s\n",caStemptime);    //snprintf(caFeedbackTableName,sizeof(caFeedbackTableName)-1, "%s", getNewLogTable("feedback",caStemptime));    //设置caProblemid为零，来进行查询    //snprintf(caProblemid, sizeof(caProblemid) - 1, "0");    //根据tsid获取username    snprintf(caUsername, sizeof(caUsername) - 1, "%s", getVnameByTsId(psShmHead, atoll(caTsid)));    //设置problemid为零    snprintf(caProblemid, sizeof(caProblemid) - 1, "0");    //获取所有信息的条数    memset(sql, 0, sizeof(sql));    snprintf(sql, sizeof(sql) - 1, "select count(*) from %s where username='%s' and problemid=%lu ", caFeedbackTableName, caUsername, strtoul(caProblemid, 0, 0));    pasDbOneRecord(sql, 0, UT_TYPE_LONG, 4, &lCount);    snprintf(sql, sizeof(sql) - 1, "select id,username,mobno,mark,status,problemid,subject,content,timeval,cuser from %s where username='%s' and problemid=%lu order by id desc limit %u,%u", caFeedbackTableName, caUsername, strtoul(caProblemid, 0, 0), lStart, ilimit);    printf("sql===========================================%s\n", sql);    psCur = pasDbOpenSql(sql, 0);    if(psCur != NULL)    {        while(0 == (iret = pasDbFetchInto(psCur,                                          UT_TYPE_ULONG, 4, &u4feedbackid,                                          UT_TYPE_STRING, sizeof(caUsername) - 1, caUsername,                                          UT_TYPE_STRING, sizeof(caMobno) - 1, caMobno,                                          UT_TYPE_STRING, sizeof(caMark) - 1, caMark,                                          UT_TYPE_STRING, sizeof(caStatus) - 1, caStatus,                                          UT_TYPE_ULONG, 4, &u4problemid,                                          UT_TYPE_STRING, sizeof(caSubject) - 1, caSubject,                                          UT_TYPE_STRING, sizeof(caContent) - 1, caContent,                                          UT_TYPE_ULONG, 8, &u8Timeval,                                          UT_TYPE_STRING, sizeof(caCuser) - 1, caCuser)) || 1405 == iret)        {            iNum++;            if(iNum > 1)            {                utPltPutLoopVar(psDbHead, "dh", iNum, ",");            }            utPltPutLoopVarF(psDbHead, "feedbackid", iNum, "%lu", u4feedbackid);            utPltPutLoopVar(psDbHead, "username", iNum, caUsername);            utPltPutLoopVar(psDbHead, "mobno", iNum, caMobno);            utPltPutLoopVar(psDbHead, "mark", iNum, caMark);            utPltPutLoopVar(psDbHead, "status", iNum, caStatus);            utPltPutLoopVarF(psDbHead, "problemid", iNum, "%lu", u4problemid);            urlencode(caSubject, sizeof(caSubject) - 1, caUrlQuestionTitle, sizeof(caUrlQuestionTitle) - 1);            utPltPutLoopVar(psDbHead, "subject", iNum, caUrlQuestionTitle);            urlencode(caContent, sizeof(caContent) - 1, caUrlQuestionContent, sizeof(caUrlQuestionContent) - 1);            utPltPutLoopVar(psDbHead, "content", iNum, caUrlQuestionContent);            //utPltPutLoopVar(psDbHead, "subject", iNum, convert("GBK", "UTF-8", caSubject));            //utPltPutLoopVar(psDbHead, "content", iNum, convert("GBK", "UTF-8", caContent));            snprintf(caTimeval, sizeof(caTimeval) - 1, "%s", utTimFormat("%Y-%m-%d  %H:%M:%S", u8Timeval));            utPltPutLoopVar(psDbHead, "timeval", iNum, caTimeval);            utPltPutLoopVar(psDbHead, "cuser", iNum,  caCuser);            snprintf(caMsg, sizeof(caMsg) - 1, "查询成功!");            utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));            utPltPutVarF(psDbHead, "result", "%d", 0);        }        pasDbCloseCursor(psCur);    }    else    {        snprintf(caMsg, sizeof(caMsg) - 1, "sql语句执行错误!");        utPltPutVar(psDbHead, "mesg", convert("GBK", "UTF-8", caMsg));        utPltPutVarF(psDbHead, "TotRec", "%lu", lCount);        utPltPutVarF(psDbHead, "result", "%d", 3);//sql语句执行错误        utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/support/show_new_question_info.htm");        return 1;    }    utPltPutVarF(psDbHead, "TotRec", "%lu", lCount);    utPltOutToHtml(iFd, psMsgHead, psDbHead, "school/support/show_new_question_info.htm");    return 0;}*///将FunName注册到系统中去int ictInitWebFun_school_hjj(utShmHead * psShmHead){	//显示常见问题	pasSetTcpFunName("ictm_show_common_questions", ictm_show_common_questions, 0);	//批量删除常见问题	pasSetTcpFunName("ictm_delete_common_questions", ictm_delete_common_questions, 0);	//显示所有用户的提的新问题	//pasSetTcpFunName("ict_show_new_question_info", ict_show_new_question_info, 0);		return 0;}